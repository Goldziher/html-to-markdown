# Cross-platform TypeScript wrapper package tasks
# Handles packages/typescript build, test, lint, and format workflows
# Works on Linux, macOS, and Windows with Node.js utilities

version: "3"
internal: true

includes:
  platforms: ../config/platforms.yml
  _cfg: ../config/vars.yml

vars:
  PNPM_VERSION: ">=10.17"
  TS_PKG: "packages/typescript"

tasks:
  install:
    desc: "Install TypeScript package dependencies"
    cmds:
      - cmd: cd {{.TS_PKG}} && pnpm install

  build:
    desc: "Build TypeScript package (production)"
    cmds:
      - cmd: cd {{.TS_PKG}} && pnpm build
    sources:
      - src/**/*.ts
      - src/**/*.tsx
      - tsconfig.json
      - package.json
    generates:
      - dist/**/*

  build:dev:
    desc: "Build TypeScript package (debug mode)"
    cmds:
      - cmd: cd {{.TS_PKG}} && pnpm build:dev || pnpm build
        ignore_error: true

  build:release:
    desc: "Build TypeScript package (release mode)"
    cmds:
      - cmd: cd {{.TS_PKG}} && pnpm build

  build:ci:
    desc: "Build TypeScript package (CI mode)"
    cmds:
      - cmd: cd {{.TS_PKG}} && pnpm build
    sources:
      - src/**/*.ts
      - src/**/*.tsx
      - tsconfig.json
      - package.json

  test:
    desc: "Run TypeScript test suite"
    cmds:
      - cmd: cd {{.TS_PKG}} && pnpm test
    sources:
      - src/**/*.ts
      - tests/**/*.spec.ts
      - package.json

  test:ci:
    desc: "Run TypeScript tests with coverage (CI mode)"
    cmds:
      - cmd: cd {{.TS_PKG}} && pnpm test:coverage
    sources:
      - src/**/*.ts
      - tests/**/*.spec.ts
      - package.json

  lint:
    desc: "Lint TypeScript with Biome (auto-fix)"
    cmds:
      - cmd: cd {{.TS_PKG}} && pnpm lint --fix
    sources:
      - src/**/*.ts
      - tests/**/*.spec.ts
      - package.json

  lint:check:
    desc: "Check TypeScript with Biome (no auto-fix)"
    cmds:
      - cmd: cd {{.TS_PKG}} && pnpm lint

  format:
    desc: "Format TypeScript code with Biome"
    cmds:
      - cmd: cd {{.TS_PKG}} && pnpm format
    sources:
      - src/**/*.ts
      - tests/**/*.spec.ts
      - package.json

  format:check:
    desc: "Check TypeScript code format (Biome)"
    cmds:
      - cmd: cd {{.TS_PKG}} && pnpm format:check

  typecheck:
    desc: "Run TypeScript type checking"
    cmds:
      - cmd: cd {{.TS_PKG}} && pnpm typecheck
        ignore_error: false
    sources:
      - src/**/*.ts
      - tests/**/*.spec.ts
      - tsconfig.json

  update:
    desc: "Update TypeScript package dependencies"
    cmds:
      - cmd: cd {{.TS_PKG}} && pnpm update

  clean:
    desc: "Clean TypeScript build artifacts and cache (cross-platform)"
    cmds:
      - cmd: cd {{.TS_PKG}} && node -e "const fs=require('fs'); ['dist','dist-node','dist-web','node_modules','.tsbuildinfo'].forEach(p=>fs.rmSync(p,{recursive:true,force:true}))"
        ignore_error: true
