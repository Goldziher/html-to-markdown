# Cross-platform Ruby Magnus bindings tasks with RBS type checking
# Compatible with Windows (PowerShell/cmd), macOS, and Linux

version: "3"
internal: true

includes:
  platforms: ../config/platforms.yml
  _cfg: ../config/vars.yml

vars:
  RUBY_WORK_DIR: "packages/ruby"

env:
  RUBY: "{{.RUBY_BIN}}/ruby"
  RB_SYS_RUBY: "{{.RUBY_BIN}}/ruby"

tasks:
  install:
    desc: "Install Ruby gem dependencies with Bundler"
    silent: false
    dir: "{{.RUBY_WORK_DIR}}"
    cmds:
      - cmd: bundle install
        ignore_error: false

  build:
    desc: "Build Ruby gem with Magnus bindings (rake compile)"
    silent: false
    dir: "{{.RUBY_WORK_DIR}}"
    cmds:
      - cmd: bundle exec rake compile
        ignore_error: false

  build:dev:
    desc: "Build Ruby gem in debug mode (rake compile)"
    silent: false
    dir: "{{.RUBY_WORK_DIR}}"
    cmds:
      - cmd: bundle exec rake compile
        ignore_error: false

  build:release:
    desc: "Build Ruby gem in release mode (rake compile)"
    silent: false
    dir: "{{.RUBY_WORK_DIR}}"
    cmds:
      - cmd: bundle exec rake compile
        ignore_error: false

  build:ci:
    desc: "Build Ruby gem for CI (rake compile)"
    silent: false
    dir: "{{.RUBY_WORK_DIR}}"
    cmds:
      - cmd: bundle exec rake compile
        ignore_error: false

  test:
    desc: "Run RSpec tests for Ruby bindings"
    silent: false
    dir: "{{.RUBY_WORK_DIR}}"
    cmds:
      - cmd: bundle exec rspec
        ignore_error: false

  test:ci:
    desc: "Run RSpec tests with coverage reporting for CI"
    silent: false
    dir: "{{.RUBY_WORK_DIR}}"
    cmds:
      - cmd: bundle exec rspec --format progress --format RspecJunitFormatter --out rspec.xml
        ignore_error: false

  lint:
    desc: "Lint Ruby code WITH auto-fix (bundle exec rubocop --autocorrect)"
    silent: false
    dir: "{{.RUBY_WORK_DIR}}"
    cmds:
      - cmd: bundle exec rubocop --autocorrect --config ./.rubocop.yml
        ignore_error: false

  lint:check:
    desc: "Lint Ruby code WITHOUT auto-fix (check-only)"
    silent: false
    dir: "{{.RUBY_WORK_DIR}}"
    cmds:
      - cmd: bundle exec rubocop --config ./.rubocop.yml
        ignore_error: false

  format:
    desc: "Format Ruby code with auto-correct (bundle exec rubocop --autocorrect)"
    silent: false
    dir: "{{.RUBY_WORK_DIR}}"
    cmds:
      - cmd: bundle exec rubocop --autocorrect --config ./.rubocop.yml
        ignore_error: false

  format:check:
    desc: "Check Ruby code formatting without modifications"
    silent: false
    dir: "{{.RUBY_WORK_DIR}}"
    cmds:
      - cmd: bundle exec rubocop --config ./.rubocop.yml
        ignore_error: false

  typecheck:
    desc: "Run Steep type checking (bundle exec steep check)"
    silent: false
    dir: "{{.RUBY_WORK_DIR}}"
    cmds:
      - cmd: bundle exec steep check
        ignore_error: false

  update:
    desc: "Update Ruby gem dependencies (bundle update)"
    silent: false
    dir: "{{.RUBY_WORK_DIR}}"
    cmds:
      - cmd: bundle update
        ignore_error: false

  clean:
    desc: "Clean Ruby build artifacts (cross-platform cleanup)"
    silent: false
    dir: "{{.RUBY_WORK_DIR}}"
    cmds:
      - cmd: ruby -e "require 'fileutils'; ['pkg', 'tmp'].each { |d| FileUtils.rm_rf(d) }; Dir['lib/*.{bundle,so}'].each { |f| File.delete(f) rescue nil }"
        ignore_error: true

  package:
    desc: "Build Ruby gem package (bundle exec rake package)"
    silent: false
    dir: "{{.RUBY_WORK_DIR}}"
    cmds:
      - cmd: bundle exec rake package
        ignore_error: false
