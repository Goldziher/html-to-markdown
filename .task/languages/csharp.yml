# Cross-platform C# P/Invoke bindings tasks with .NET
# Compatible with Windows (PowerShell/cmd), macOS, and Linux

version: "3"
internal: true

includes:
  platforms: ../config/platforms.yml
  _cfg: ../config/vars.yml

vars:
  BUILD_PROFILE: "{{.BUILD_PROFILE | default \"release\"}}"
  CSHARP_PKG: "packages/csharp"

tasks:
  install:
    desc: "Restore .NET dependencies"
    silent: false
    cmds:
      - cmd: cd {{.CSHARP_PKG}} && dotnet restore
        ignore_error: false

  build:
    desc: "Build FFI + .NET project ({{.BUILD_PROFILE}} profile)"
    silent: false
    cmds:
      - cmd: cd {{.CSHARP_PKG}} && cargo build{{if eq .BUILD_PROFILE "release"}} --release{{end}} -p html-to-markdown-ffi
        ignore_error: false
      - cmd: cd {{.CSHARP_PKG}} && dotnet build --configuration {{if eq .BUILD_PROFILE "release"}}Release{{else}}Debug{{end}}
        ignore_error: false

  build:dev:
    desc: "Build FFI + .NET project in debug mode"
    silent: false
    cmds:
      - cmd: cd {{.CSHARP_PKG}} && cargo build -p html-to-markdown-ffi
        ignore_error: false
      - cmd: cd {{.CSHARP_PKG}} && dotnet build --configuration Debug
        ignore_error: false

  build:release:
    desc: "Build FFI + .NET project in release mode"
    silent: false
    cmds:
      - cmd: cd {{.CSHARP_PKG}} && cargo build --release -p html-to-markdown-ffi
        ignore_error: false
      - cmd: cd {{.CSHARP_PKG}} && dotnet build --configuration Release
        ignore_error: false

  build:ci:
    desc: "Build FFI + .NET project for CI (release)"
    silent: false
    cmds:
      - cmd: cd {{.CSHARP_PKG}} && cargo build --release -p html-to-markdown-ffi
        ignore_error: false
      - cmd: cd {{.CSHARP_PKG}} && dotnet build --configuration Release
        ignore_error: false

  test:
    desc: "Run .NET tests with library path"
    silent: false
    cmds:
      - cmd: cd {{.CSHARP_PKG}} && cargo build --release -p html-to-markdown-ffi
        ignore_error: false
      - cmd: cd {{.CSHARP_PKG}} && dotnet test --no-build --configuration Release
        ignore_error: false
        env:
          LD_LIBRARY_PATH: '{{if ne .OS "windows"}}{{.TASKFILE_DIR}}/target/release{{if .LD_LIBRARY_PATH}}:{{.LD_LIBRARY_PATH}}{{end}}{{end}}'
          DYLD_LIBRARY_PATH: '{{if eq .OS "darwin"}}{{.TASKFILE_DIR}}/target/release{{if .DYLD_LIBRARY_PATH}}:{{.DYLD_LIBRARY_PATH}}{{end}}{{end}}'
          PATH: '{{if eq .OS "windows"}}{{.TASKFILE_DIR}}/target/release;{{end}}{{.PATH}}'

  test:ci:
    desc: "Run .NET tests with coverage reporting for CI"
    silent: false
    cmds:
      - cmd: cd {{.CSHARP_PKG}} && cargo build --release -p html-to-markdown-ffi
        ignore_error: false
      - cmd: cd {{.CSHARP_PKG}} && dotnet test --configuration Release --collect:"XPlat Code Coverage"
        ignore_error: false
        env:
          LD_LIBRARY_PATH: '{{if ne .OS "windows"}}{{.TASKFILE_DIR}}/target/release{{if .LD_LIBRARY_PATH}}:{{.LD_LIBRARY_PATH}}{{end}}{{end}}'
          DYLD_LIBRARY_PATH: '{{if eq .OS "darwin"}}{{.TASKFILE_DIR}}/target/release{{if .DYLD_LIBRARY_PATH}}:{{.DYLD_LIBRARY_PATH}}{{end}}{{end}}'
          PATH: '{{if eq .OS "windows"}}{{.TASKFILE_DIR}}/target/release;{{end}}{{.PATH}}'

  lint:
    desc: "Lint and format C# code WITH auto-fix (dotnet format)"
    silent: false
    cmds:
      - cmd: cd {{.CSHARP_PKG}} && dotnet format
        ignore_error: false

  lint:check:
    desc: "Lint C# code WITHOUT auto-fix (check-only)"
    silent: false
    cmds:
      - cmd: cd {{.CSHARP_PKG}} && dotnet format --verify-no-changes
        ignore_error: false

  format:
    desc: "Format C# code with auto-fix (dotnet format)"
    silent: false
    cmds:
      - cmd: cd {{.CSHARP_PKG}} && dotnet format
        ignore_error: false

  format:check:
    desc: "Check C# code formatting without modifications"
    silent: false
    cmds:
      - cmd: cd {{.CSHARP_PKG}} && dotnet format --verify-no-changes
        ignore_error: false

  update:
    desc: "Check .NET package updates"
    silent: false
    cmds:
      - cmd: cd {{.CSHARP_PKG}} && dotnet list package --outdated
        ignore_error: false

  clean:
    desc: "Clean C# build artifacts (cross-platform cleanup)"
    silent: false
    cmds:
      - cmd: cd {{.CSHARP_PKG}} && dotnet clean
        ignore_error: true
      - cmd: cd {{.CSHARP_PKG}} && dotnet build-server shutdown
        ignore_error: true

  pack:
    desc: "Build C# NuGet package"
    silent: false
    cmds:
      - cmd: cd {{.CSHARP_PKG}} && dotnet pack --configuration Release
        ignore_error: false
