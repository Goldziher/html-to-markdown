# Cross-platform Elixir Rustler NIF bindings tasks
# Compatible with Windows (PowerShell/cmd), macOS, and Linux

version: "3"
internal: true

includes:
  platforms: ../config/platforms.yml
  _cfg: ../config/vars.yml

vars:
  ELIXIR_PKG: "packages/elixir"

env:
  MIX_ENV: "dev"

tasks:
  install:
    desc: "Install Elixir dependencies with Mix"
    silent: false
    cmds:
      - cmd: cd {{.ELIXIR_PKG}} && pwd && ls -la mix.exs
        ignore_error: false
      - cmd: cd {{.ELIXIR_PKG}} && mix local.hex --force
        ignore_error: false
      - cmd: cd {{.ELIXIR_PKG}} && mix local.rebar --force
        ignore_error: false
      - cmd: cd {{.ELIXIR_PKG}} && mix deps.get
        ignore_error: false

  build:
    desc: "Build Elixir project with Rustler NIF (dev profile)"
    silent: false
    cmds:
      - cmd: cd {{.ELIXIR_PKG}} && mix compile
        env:
          MIX_ENV: "dev"
        ignore_error: false

  build:dev:
    desc: "Build Elixir project in dev mode (unoptimized, faster compile)"
    silent: false
    cmds:
      - cmd: cd {{.ELIXIR_PKG}} && mix compile
        env:
          MIX_ENV: "dev"
        ignore_error: false

  build:release:
    desc: "Build Elixir project in release mode (optimized Rust NIF)"
    silent: false
    cmds:
      - cmd: cd {{.ELIXIR_PKG}} && mix compile
        env:
          MIX_ENV: "prod"
        ignore_error: false

  build:ci:
    desc: "Build Elixir project for CI (test environment)"
    silent: false
    cmds:
      - cmd: cd {{.ELIXIR_PKG}} && mix compile
        env:
          MIX_ENV: "test"
        ignore_error: false

  test:
    desc: "Run ExUnit tests for Elixir bindings"
    silent: false
    cmds:
      - cmd: cd {{.ELIXIR_PKG}} && mix test
        env:
          MIX_ENV: "test"
        ignore_error: false

  test:ci:
    desc: "Run ExUnit tests with coverage reporting for CI"
    silent: false
    cmds:
      - cmd: cd {{.ELIXIR_PKG}} && mix test --cover
        env:
          MIX_ENV: "test"
        ignore_error: false

  lint:
    desc: "Lint Elixir code WITH auto-fix (mix format + mix credo --strict)"
    silent: false
    cmds:
      - cmd: cd {{.ELIXIR_PKG}} && mix format
        ignore_error: false
      - cmd: cd {{.ELIXIR_PKG}} && mix credo --strict
        ignore_error: false

  lint:check:
    desc: "Lint Elixir code WITHOUT auto-fix (check-only)"
    silent: false
    cmds:
      - cmd: cd {{.ELIXIR_PKG}} && mix format --check-formatted
        ignore_error: false
      - cmd: cd {{.ELIXIR_PKG}} && mix credo
        ignore_error: false

  format:
    desc: "Format Elixir code with mix format"
    silent: false
    cmds:
      - cmd: cd {{.ELIXIR_PKG}} && mix format
        ignore_error: false

  format:check:
    desc: "Check Elixir code formatting without modifications"
    silent: false
    cmds:
      - cmd: cd {{.ELIXIR_PKG}} && mix format --check-formatted
        ignore_error: false

  dialyzer:
    desc: "Run Dialyzer for static type analysis"
    silent: false
    cmds:
      - cmd: cd {{.ELIXIR_PKG}} && mix dialyzer
        ignore_error: false

  update:
    desc: "Update Elixir dependencies (mix deps.update --all)"
    silent: false
    cmds:
      - cmd: cd {{.ELIXIR_PKG}} && mix deps.update --all
        ignore_error: false

  clean:
    desc: "Clean Elixir build artifacts (cross-platform cleanup)"
    silent: false
    cmds:
      - cmd: cd {{.ELIXIR_PKG}} && mix clean
        ignore_error: false
      - cmd: cd {{.ELIXIR_PKG}} && mix deps.clean --all
        ignore_error: true

  release:
    desc: "Build Elixir release (mix release)"
    silent: false
    cmds:
      - cmd: cd {{.ELIXIR_PKG}} && mix release
        env:
          MIX_ENV: "prod"
        ignore_error: false
