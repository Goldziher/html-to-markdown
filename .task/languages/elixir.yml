# Cross-platform Elixir Rustler NIF bindings tasks
# Compatible with Windows (PowerShell/cmd), macOS, and Linux

version: "3"
internal: true

includes:
  platforms: ../config/platforms.yml

vars:
  ELIXIR_WORK_DIR: "{{.PACKAGES_DIR}}/elixir"

env:
  MIX_ENV: "dev"

tasks:
  install:
    desc: "Install Elixir dependencies with Mix"
    silent: false
    dir: "{{.ELIXIR_WORK_DIR}}"
    cmds:
      - cmd: mix local.hex --force
        ignore_error: false
      - cmd: mix local.rebar --force
        ignore_error: false
      - cmd: mix deps.get
        ignore_error: false

  build:
    desc: "Build Elixir project with Rustler NIF (dev profile)"
    silent: false
    dir: "{{.ELIXIR_WORK_DIR}}"
    cmds:
      - cmd: mix compile
        env:
          MIX_ENV: "dev"
        ignore_error: false

  build:dev:
    desc: "Build Elixir project in dev mode (unoptimized, faster compile)"
    silent: false
    dir: "{{.ELIXIR_WORK_DIR}}"
    cmds:
      - cmd: mix compile
        env:
          MIX_ENV: "dev"
        ignore_error: false

  build:release:
    desc: "Build Elixir project in release mode (optimized Rust NIF)"
    silent: false
    dir: "{{.ELIXIR_WORK_DIR}}"
    cmds:
      - cmd: mix compile
        env:
          MIX_ENV: "prod"
        ignore_error: false

  build:ci:
    desc: "Build Elixir project for CI (test environment)"
    silent: false
    dir: "{{.ELIXIR_WORK_DIR}}"
    cmds:
      - cmd: mix compile
        env:
          MIX_ENV: "test"
        ignore_error: false

  test:
    desc: "Run ExUnit tests for Elixir bindings"
    silent: false
    dir: "{{.ELIXIR_WORK_DIR}}"
    cmds:
      - cmd: mix test
        env:
          MIX_ENV: "test"
        ignore_error: false

  test:ci:
    desc: "Run ExUnit tests with coverage reporting for CI"
    silent: false
    dir: "{{.ELIXIR_WORK_DIR}}"
    cmds:
      - cmd: mix test --cover
        env:
          MIX_ENV: "test"
        ignore_error: false

  lint:
    desc: "Lint Elixir code WITH auto-fix (mix format + mix credo --strict)"
    silent: false
    dir: "{{.ELIXIR_WORK_DIR}}"
    cmds:
      - cmd: mix format
        ignore_error: false
      - cmd: mix credo --strict
        ignore_error: false

  lint:check:
    desc: "Lint Elixir code WITHOUT auto-fix (check-only)"
    silent: false
    dir: "{{.ELIXIR_WORK_DIR}}"
    cmds:
      - cmd: mix format --check-formatted
        ignore_error: false
      - cmd: mix credo
        ignore_error: false

  format:
    desc: "Format Elixir code with mix format"
    silent: false
    dir: "{{.ELIXIR_WORK_DIR}}"
    cmds:
      - cmd: mix format
        ignore_error: false

  format:check:
    desc: "Check Elixir code formatting without modifications"
    silent: false
    dir: "{{.ELIXIR_WORK_DIR}}"
    cmds:
      - cmd: mix format --check-formatted
        ignore_error: false

  dialyzer:
    desc: "Run Dialyzer for static type analysis"
    silent: false
    dir: "{{.ELIXIR_WORK_DIR}}"
    cmds:
      - cmd: mix dialyzer
        ignore_error: false

  update:
    desc: "Update Elixir dependencies (mix deps.update --all)"
    silent: false
    dir: "{{.ELIXIR_WORK_DIR}}"
    cmds:
      - cmd: mix deps.update --all
        ignore_error: false

  clean:
    desc: "Clean Elixir build artifacts (cross-platform cleanup)"
    silent: false
    dir: "{{.ELIXIR_WORK_DIR}}"
    cmds:
      - cmd: mix clean
        ignore_error: false
      - cmd: mix deps.clean --all
        ignore_error: true

  release:
    desc: "Build Elixir release (mix release)"
    silent: false
    dir: "{{.ELIXIR_WORK_DIR}}"
    cmds:
      - cmd: mix release
        env:
          MIX_ENV: "prod"
        ignore_error: false
