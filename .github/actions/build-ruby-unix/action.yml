name: Build Ruby gem (Unix)
description: Builds Ruby gem on Unix platforms (Linux/macOS)

runs:
  using: composite
  steps:
    - name: Set LD_LIBRARY_PATH (Linux)
      if: runner.os == 'Linux'
      shell: bash
      run: echo "LD_LIBRARY_PATH=$(ruby -rrbconfig -e'puts RbConfig::CONFIG["libdir"]')${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}" >> $GITHUB_ENV

    - name: Install Ruby gems
      shell: bash
      working-directory: packages/ruby
      run: bundle install

    - name: Compile Ruby extension
      shell: bash
      working-directory: packages/ruby
      env:
        RB_SYS_CARGO_PROFILE: release
      run: bundle exec rake compile
