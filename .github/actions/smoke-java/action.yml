name: Smoke test Java bindings
description: Tests Java JAR installation and functionality

inputs:
  jar-path:
    description: Path to the JAR file (optional, uses local if not provided)
    required: false
    default: ""

runs:
  using: composite
  steps:
    - name: Smoke Java install
      shell: bash
      run: |
        set -euo pipefail
        tmp=$(mktemp -d)
        cp -R examples/java-smoke/. "$tmp"/
        pushd "$tmp" >/dev/null

        if [[ -n "${{ inputs.jar-path }}" ]]; then
          version="$(
            python3 - <<'PY'
            import os
            import xml.etree.ElementTree as ET
            from pathlib import Path

            pom = Path(os.environ["GITHUB_WORKSPACE"]) / "examples" / "java-smoke" / "pom.xml"
            ns = {"m": "http://maven.apache.org/POM/4.0.0"}

            tree = ET.parse(pom)
            version = None
            for dep in tree.findall(".//m:dependency", ns):
                gid = dep.find("m:groupId", ns)
                aid = dep.find("m:artifactId", ns)
                ver = dep.find("m:version", ns)
                if gid is not None and aid is not None and gid.text and aid.text:
                    if gid.text.strip() == "io.github.goldziher" and aid.text.strip() == "html-to-markdown":
                        version = (ver.text if ver is not None else "").strip()
                        break

            if not version:
                raise SystemExit("Unable to determine html-to-markdown version from examples/java-smoke/pom.xml")

            print(version)
        PY
          )"

          # Install the JAR to local Maven repository
          mvn install:install-file \
            -Dfile="${{ inputs.jar-path }}" \
            -DgroupId=io.github.goldziher \
            -DartifactId=html-to-markdown \
            -Dversion="$version" \
            -Dpackaging=jar \
            -DgeneratePom=true
        else
          # Install from local packages/java/target
          pushd "${GITHUB_WORKSPACE}/packages/java" >/dev/null
          mvn install -DskipTests -Dgpg.skip=true
          popd >/dev/null
        fi

        # Compile and run the smoke test
        mvn compile exec:java -Dexec.mainClass="io.github.goldziher.htmltomarkdown.SmokeTest"
        popd >/dev/null
        echo "âœ“ Java JAR smoke test passed"
