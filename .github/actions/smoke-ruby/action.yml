name: Smoke test Ruby gem
description: Tests Ruby gem installation and functionality

inputs:
  gem-file:
    description: Path to the Ruby gem file (optional, uses local if not provided)
    required: false
    default: ""

runs:
  using: composite
  steps:
    - name: Smoke Ruby install
      shell: bash
      run: |
        set -euo pipefail
        gem_file="${{ inputs.gem-file }}"
        if [[ -n "${gem_file}" && "${gem_file}" != /* ]]; then
          gem_file="${GITHUB_WORKSPACE}/${gem_file}"
        fi
        if [[ -n "${gem_file}" && ! -f "${gem_file}" ]]; then
          echo "error: gem file not found: ${gem_file}" >&2
          exit 1
        fi

        tmp=$(mktemp -d)
        cp -R examples/ruby-smoke/. "$tmp"/
        pushd "$tmp" >/dev/null

        if [[ -n "${gem_file}" ]]; then
          gem install "${gem_file}" --no-document
          ruby app.rb
          popd >/dev/null
          echo "✓ Ruby gem smoke test passed"
          exit 0
        fi

        bundle config set --local path vendor/bundle
        bundle config set --local local.html-to-markdown "${GITHUB_WORKSPACE}/packages/ruby"
        bundle install
        bundle exec ruby app.rb
        popd >/dev/null
        echo "✓ Ruby gem smoke test passed"
