name: CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  rust-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt, clippy, llvm-tools-preview
          rustflags: ""

      - name: Run Rust Tests
        env:
          RUST_BACKTRACE: full
        run: |
          echo "Running Rust tests with full debugging..."
          cargo test --release --no-default-features --workspace --exclude html-to-markdown-rb --exclude html-to-markdown-php -vv -- --nocapture --test-threads=1

      - name: Check Rust Formatting
        if: matrix.os == 'ubuntu-latest'
        run: cargo fmt --check

      - name: Run Clippy
        if: matrix.os == 'ubuntu-latest'
        run: cargo clippy -- -D warnings

  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt, clippy, llvm-tools-preview

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: false

      - name: Install Ruby dependencies for lint
        working-directory: packages/ruby
        run: bundle install --jobs 4 --retry 3

      - name: Install Dependencies
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 30
          command: uv sync --all-extras
          shell: bash

      - name: Run Rust Checks
        run: |
          cargo fmt --check
          cargo clippy --workspace --exclude html-to-markdown-rb --exclude html-to-markdown-php -- -D warnings

      - name: Install prek
        run: |
          uv tool install prek
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Load Cached Prek Dependencies
        id: cached-prek-dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/prek/
          key: prek|${{ env.pythonLocation }}|${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Execute Prek
        run: prek run --show-diff-on-failure --color=always --all-files

  coverage:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt, clippy, llvm-tools-preview
          rustflags: ""

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov

      - name: Generate Rust Coverage
        run: cargo llvm-cov --workspace --exclude html-to-markdown-py --exclude html-to-markdown-rb --exclude html-to-markdown-php --exclude html-to-markdown-node --exclude html-to-markdown-wasm --all-features --lcov --output-path coverage.lcov

      - name: Upload Coverage Artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: coverage-report-${{ github.sha }}
          path: coverage.lcov
          retention-days: 7

  test:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python: ["3.10", "3.12", "3.14"]
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python }}

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt, clippy, llvm-tools-preview

      - name: Install Dependencies
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            if [[ "${{ runner.os }}" == "Windows" ]] && [[ -d ".venv" ]]; then
              echo "Removing existing .venv directory on Windows"
              rm -rf .venv
            fi
            uv sync --all-extras
          shell: bash

      - name: Build CLI Binary
        run: cargo build --release --package html-to-markdown-cli

      - name: Test
        run: uv run pytest

  ruby-bindings:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        ruby: ["3.2", "3.3"]
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Setup Ruby (Unix)
        if: runner.os != 'Windows'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: false
          working-directory: packages/ruby

      - name: Setup Ruby (Windows)
        if: runner.os == 'Windows'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: false
          working-directory: packages/ruby
          msys2: UCRT64

      - name: Install MSYS2 toolchain
        if: runner.os == 'Windows'
        shell: pwsh
        run: ridk exec pacman -S --needed --noconfirm base-devel mingw-w64-ucrt-x86_64-toolchain

      - name: Install Rust GNU toolchain
        if: runner.os == 'Windows'
        shell: bash
        run: rustup toolchain install stable-gnu --profile minimal --no-self-update

      - name: Configure bindgen sysroot (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: echo "BINDGEN_EXTRA_CLANG_ARGS=--target=x86_64-pc-windows-gnu --sysroot=${RI_DEVKIT//\\/\/}$MSYSTEM_PREFIX" >> $GITHUB_ENV

      - name: Build CLI binary
        run: cargo build --release --package html-to-markdown-cli

      - name: Install Bundler 2.5.12 (Unix)
        if: runner.os != 'Windows'
        run: gem install bundler -v 2.5.12

      - name: Install Bundler 2.5.12 (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ridk exec gem install bundler -v 2.5.12

      - name: Install Ruby gems (Unix)
        if: runner.os != 'Windows'
        working-directory: packages/ruby
        run: bundle _2.5.12_ install

      - name: Run Rubocop (Unix)
        if: runner.os != 'Windows' && matrix.os == 'ubuntu-latest' && matrix.ruby == '3.3'
        working-directory: packages/ruby
        run: bundle _2.5.12_ exec rubocop --config .rubocop.yml

      - name: Install Ruby gems (Windows)
        if: runner.os == 'Windows'
        working-directory: packages/ruby
        shell: pwsh
        run: |
          $unixPath = ridk exec bash -lc "cygpath -au '$env:GITHUB_WORKSPACE/packages/ruby'"
          ridk exec bash -lc "cd $unixPath && export RUSTUP_TOOLCHAIN=stable-gnu CC=x86_64-w64-mingw32-gcc CXX=x86_64-w64-mingw32-g++ && bundle _2.5.12_ install"

      - name: Compile Ruby extension (Unix)
        if: runner.os != 'Windows'
        working-directory: packages/ruby
        env:
          RB_SYS_CARGO_PROFILE: release
        run: bundle _2.5.12_ exec rake compile

      - name: Compile Ruby extension (Windows)
        if: runner.os == 'Windows'
        working-directory: packages/ruby
        env:
          RB_SYS_CARGO_PROFILE: release
        shell: pwsh
        run: |
          $unixPath = ridk exec bash -lc "cygpath -au '$env:GITHUB_WORKSPACE/packages/ruby'"
          ridk exec bash -lc "cd $unixPath && export RUSTUP_TOOLCHAIN=stable-gnu CC=x86_64-w64-mingw32-gcc CXX=x86_64-w64-mingw32-g++ && bundle _2.5.12_ exec rake compile"

      - name: Run Ruby specs (Unix)
        if: runner.os != 'Windows'
        working-directory: packages/ruby
        run: bundle _2.5.12_ exec rspec --format progress

      - name: Run Ruby specs (Windows)
        if: runner.os == 'Windows'
        working-directory: packages/ruby
        shell: pwsh
        run: |
          $unixPath = ridk exec bash -lc "cygpath -au '$env:GITHUB_WORKSPACE/packages/ruby'"
          ridk exec bash -lc "cd $unixPath && export RUSTUP_TOOLCHAIN=stable-gnu CC=x86_64-w64-mingw32-gcc CXX=x86_64-w64-mingw32-g++ && bundle _2.5.12_ exec rspec --format progress"

  php-bindings:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          coverage: none

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install Composer dependencies
        uses: ramsey/composer-install@v3
        with:
          working-directory: packages/php
          dependency-versions: locked

      - name: Build PHP extension
        run: cargo build -p html-to-markdown-php --release

      - name: Run PHP static analysis
        working-directory: packages/php
        run: composer run phpstan

      - name: Run PHP tests
        working-directory: packages/php
        run: composer run test

  node-bindings:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Setup workspace
        uses: ./.github/actions/setup-node-workspace

      - name: Build NAPI-RS Bindings
        working-directory: crates/html-to-markdown-node
        run: pnpm run build

      - name: Test NAPI-RS Bindings
        working-directory: crates/html-to-markdown-node
        run: pnpm test

      - name: Run Rust Tests
        working-directory: crates/html-to-markdown-node
        run: cargo test

      - name: Build TypeScript package
        working-directory: packages/typescript
        run: pnpm run build

      - name: Test TypeScript package
        working-directory: packages/typescript
        run: pnpm test

  wasm-bindings:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Setup workspace
        uses: ./.github/actions/setup-node-workspace

      - name: Build WASM (all targets)
        working-directory: crates/html-to-markdown-wasm
        run: pnpm run build:all

      - name: Test WASM
        working-directory: crates/html-to-markdown-wasm
        run: pnpm test

      - name: Run Rust Tests
        working-directory: crates/html-to-markdown-wasm
        run: cargo test

  smoke:
    name: Smoke README installs
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          check-latest: true

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Setup Ruby
        if: runner.os != 'Windows'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: false

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install wasm-pack
        run: |
          set -euo pipefail
          if ! command -v wasm-pack >/dev/null 2>&1; then
            cargo install wasm-pack --locked
          fi

      - name: Setup PHP
        if: runner.os != 'Windows'
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          tools: composer

      - name: Capture php-config path
        if: runner.os != 'Windows'
        run: echo "PHP_CONFIG=$(command -v php-config)" >> "$GITHUB_ENV"

      - name: Install pnpm workspace deps
        run: pnpm install

      - name: Build Node bindings
        run: pnpm --filter html-to-markdown-node run build

      - name: Pack Node tarball
        run: |
          set -euo pipefail
          pushd crates/html-to-markdown-node >/dev/null
          NODE_TGZ=$(npm pack | tail -1)
          mv "$NODE_TGZ" "$GITHUB_WORKSPACE/$NODE_TGZ"
          popd >/dev/null
          echo "NODE_TGZ=$GITHUB_WORKSPACE/$NODE_TGZ" >> "$GITHUB_ENV"

      - name: Smoke Node install
        run: |
          set -euo pipefail
          tmp=$(python - <<'PY2'
import tempfile
print(tempfile.mkdtemp(prefix="smoke-node-"))
PY2
)
          cp -R examples/node-smoke/. "$tmp"/
          pushd "$tmp" >/dev/null
          pnpm install
          cp "$NODE_TGZ" ./node.tgz
          pnpm add ./node.tgz
          pnpm run check
          popd >/dev/null

      - name: Build WASM bundle
        run: pnpm --filter html-to-markdown-wasm run build:all

      - name: Pack WASM tarball
        run: |
          set -euo pipefail
          pushd crates/html-to-markdown-wasm >/dev/null
          WASM_TGZ=$(npm pack | tail -1)
          mv "$WASM_TGZ" "$GITHUB_WORKSPACE/$WASM_TGZ"
          popd >/dev/null
          echo "WASM_TGZ=$GITHUB_WORKSPACE/$WASM_TGZ" >> "$GITHUB_ENV"

      - name: Smoke WASM install
        run: |
          set -euo pipefail
          tmp=$(python - <<'PY2'
import tempfile
print(tempfile.mkdtemp(prefix="smoke-wasm-"))
PY2
)
          cp -R examples/wasm-smoke/. "$tmp"/
          pushd "$tmp" >/dev/null
          pnpm install
          cp "$WASM_TGZ" ./wasm.tgz
          pnpm add ./wasm.tgz
          pnpm run check
          popd >/dev/null

      - name: Smoke Python install
        run: |
          set -euo pipefail
          tmp=$(python - <<'PY2'
import tempfile
print(tempfile.mkdtemp(prefix="smoke-python-"))
PY2
)
          cp -R examples/python-smoke/. "$tmp"/
          pushd "$tmp" >/dev/null
          python -m venv .venv
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            VENV_PY=".venv/Scripts/python.exe"
          else
            VENV_PY=".venv/bin/python"
          fi
          "$VENV_PY" -m pip install --upgrade pip
          "$VENV_PY" -m pip install "${GITHUB_WORKSPACE}/packages/python"
          "$VENV_PY" main.py
          popd >/dev/null

      - name: Smoke Ruby install
        if: runner.os != 'Windows'
        run: |
          set -euo pipefail
          tmp=$(python - <<'PY2'
import tempfile
print(tempfile.mkdtemp(prefix="smoke-ruby-"))
PY2
)
          cp -R examples/ruby-smoke/. "$tmp"/
          pushd "$tmp" >/dev/null
          gem list -i bundler -v 2.5.12 || gem install bundler -v 2.5.12 --no-document
          bundle config set --local path vendor/bundle
          bundle config set --local local.html-to-markdown "${GITHUB_WORKSPACE}/packages/ruby"
          bundle install
          bundle exec ruby app.rb
          popd >/dev/null

      - name: Build PHP extension
        if: runner.os != 'Windows'
        env:
          PHP_CONFIG: ${{ env.PHP_CONFIG }}
        run: cargo build --release -p html-to-markdown-php

      - name: Smoke PHP install
        if: runner.os != 'Windows'
        env:
          EXT_PATH: ${{ github.workspace }}/target/release/libhtml_to_markdown_php.so
          COMPOSER_ALLOW_SUPERUSER: 1
        run: |
          set -euo pipefail
          tmp=$(python - <<'PY2'
import tempfile
print(tempfile.mkdtemp(prefix="smoke-php-"))
PY2
)
          cp -R examples/php-smoke/. "$tmp"/
          pushd "$tmp" >/dev/null
          composer_bin=$(command -v composer)
          php -d "extension=$EXT_PATH" "$composer_bin" config repositories.local path "${GITHUB_WORKSPACE}/packages/php" --no-plugins
          php -d "extension=$EXT_PATH" "$composer_bin" config repositories.local.options.symlink false --no-plugins
          php -d "extension=$EXT_PATH" "$composer_bin" install --no-interaction --no-progress --no-scripts
          php -d "extension=$EXT_PATH" convert.php
          popd >/dev/null

      - name: Smoke Rust example
        run: |
          set -euo pipefail
          tmp=$(python - <<'PY2'
import tempfile
print(tempfile.mkdtemp(prefix="smoke-rust-"))
PY2
)
          cp -R examples/rust-smoke/. "$tmp"/
          pushd "$tmp" >/dev/null
          mkdir -p .cargo
          cp .cargo/config.local-template.toml .cargo/config.toml 2>/dev/null || true
          cargo run --quiet
          popd >/dev/null
