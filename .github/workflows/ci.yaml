name: CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: "1.25.0-rc.1"
  GO_TOOLCHAIN: "go1.25rc1"
  GOLANGCI_LINT_VERSION: "v2.6.2"

jobs:
  rust-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt, clippy, llvm-tools-preview
          rustflags: ""

      - name: Run Rust Tests
        env:
          RUST_BACKTRACE: full
        run: |
          echo "Running Rust tests with full debugging..."
          cargo test --release --no-default-features --workspace --exclude html-to-markdown-rb --exclude html-to-markdown-php --exclude html-to-markdown-wasm-wasmtime-tests -vv -- --nocapture --test-threads=1

      - name: Check Rust Formatting
        if: matrix.os == 'ubuntu-latest'
        run: cargo fmt --check

      - name: Run Clippy
        if: matrix.os == 'ubuntu-latest'
        run: cargo clippy -- -D warnings

  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt, clippy, llvm-tools-preview

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.19"
          otp-version: "28.1"

      - name: Install Elixir dependencies
        working-directory: packages/elixir
        run: mix deps.get

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: false

      - name: Install Ruby dependencies for lint
        working-directory: packages/ruby
        run: bundle install --jobs 4 --retry 3

      - name: Install Dependencies
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 30
          command: uv sync --all-extras --no-install-workspace
          shell: bash

      - name: Run Rust Checks
        run: |
          cargo fmt --check
          cargo clippy --workspace --exclude html-to-markdown-rb --exclude html-to-markdown-php -- -D warnings

      - name: Install prek
        run: |
          uv tool install prek
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Load Cached Prek Dependencies
        id: cached-prek-dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/prek/
          key: prek|${{ env.pythonLocation }}|${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Execute Prek
        env:
          SKIP: golangci-lint-packages,golangci-lint-examples
        run: prek run --show-diff-on-failure --color=always --all-files

  detect-go-modules:
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.set-modules.outputs.modules }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Detect Go modules
        id: set-modules
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t modules < <(git ls-files -- '*/go.mod' | sort)
          if [[ "${#modules[@]}" -eq 0 ]]; then
            echo "modules=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          json=$(printf '%s\n' "${modules[@]}" | sed 's|/go\.mod$||' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "modules=$json" >> "$GITHUB_OUTPUT"

  golangci-lint:
    name: golangci-lint (${{ matrix.module }})
    needs: detect-go-modules
    if: ${{ needs.detect-go-modules.outputs.modules != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        module: ${{ fromJson(needs.detect-go-modules.outputs.modules) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true

      - name: Install golangci-lint
        env:
          GOTOOLCHAIN: ${{ env.GO_TOOLCHAIN }}
        run: |
          set -euo pipefail
          echo "$HOME/go/bin" >> "$GITHUB_PATH"
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@${{ env.GOLANGCI_LINT_VERSION }}

      - name: Run golangci-lint
        working-directory: ${{ matrix.module }}
        run: golangci-lint run --config ../../.golangci.yml ./...

  coverage:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt, clippy, llvm-tools-preview
          rustflags: ""

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov

      - name: Generate Rust Coverage
        run: cargo llvm-cov --workspace --exclude html-to-markdown-py --exclude html-to-markdown-rb --exclude html-to-markdown-php --exclude html-to-markdown-node --exclude html-to-markdown-wasm --exclude html-to-markdown-wasm-wasmtime-tests --all-features --lcov --output-path coverage.lcov

      - name: Upload Coverage Artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: coverage-report-${{ github.sha }}
          path: coverage.lcov
          retention-days: 7

  test:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python: ["3.10", "3.12", "3.14"]
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python }}

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt, clippy, llvm-tools-preview

      - name: Install Dependencies
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            if [[ "${{ runner.os }}" == "Windows" ]] && [[ -d ".venv" ]]; then
              echo "Removing existing .venv directory on Windows"
              rm -rf .venv
            fi
            uv sync --all-extras --no-install-workspace
          shell: bash

      - name: Build CLI Binary
        run: cargo build --release --package html-to-markdown-cli

      - name: Test
        run: uv run pytest

  ruby-bindings:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        ruby: ["3.2", "3.3"]
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Setup Ruby (Unix)
        if: runner.os != 'Windows'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler: "2.7.2"
          bundler-cache: false
          working-directory: packages/ruby

      - name: Setup Ruby (Windows)
        if: runner.os == 'Windows'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler: "2.7.2"
          bundler-cache: false
          working-directory: packages/ruby
          windows-toolchain: UCRT64

      - name: Build CLI binary
        uses: ./.github/actions/build-cli

      - name: Build Ruby extension (Unix)
        if: runner.os != 'Windows'
        uses: ./.github/actions/build-ruby-unix

      - name: Run Rubocop (Unix)
        if: runner.os != 'Windows' && matrix.os == 'ubuntu-latest' && matrix.ruby == '3.3'
        working-directory: packages/ruby
        run: bundle exec rubocop --config .rubocop.yml

      - name: Validate RBS signatures (Unix)
        if: runner.os != 'Windows' && matrix.os == 'ubuntu-latest' && matrix.ruby == '3.3'
        working-directory: packages/ruby
        run: bundle exec rbs validate

      - name: Run Steep type checking (Unix)
        if: runner.os != 'Windows' && matrix.os == 'ubuntu-latest' && matrix.ruby == '3.3'
        working-directory: packages/ruby
        run: bundle exec steep check

      - name: Build Ruby extension (Windows)
        if: runner.os == 'Windows'
        uses: ./.github/actions/build-ruby-windows

      - name: Run Ruby specs (Unix)
        if: runner.os != 'Windows'
        working-directory: packages/ruby
        run: bundle exec rspec --format progress

      - name: Run Ruby specs (Windows)
        if: runner.os == 'Windows'
        working-directory: packages/ruby
        shell: pwsh
        run: |
          $unixPath = ridk exec bash -lc "cygpath -au '$env:GITHUB_WORKSPACE/packages/ruby'"
          ridk exec bash -lc "cd $unixPath && export RUSTUP_TOOLCHAIN=stable-gnu CC=x86_64-w64-mingw32-gcc CXX=x86_64-w64-mingw32-g++ && bundle exec rspec --format progress"

  php-bindings:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          tools: composer:2.9.1
          coverage: none

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Capture php-config path
        run: echo "PHP_CONFIG=$(command -v php-config)" >> "$GITHUB_ENV"

      - name: Install Composer dependencies
        uses: ramsey/composer-install@v3
        with:
          working-directory: packages/php
          dependency-versions: locked

      - name: Build PHP extension
        uses: ./.github/actions/build-php-linux
        with:
          php-config: ${{ env.PHP_CONFIG }}

      - name: Run PHP static analysis
        working-directory: packages/php
        run: composer run phpstan

      - name: Run PHP tests
        working-directory: packages/php
        run: composer run test

  java-bindings:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        java: ["22", "23"]
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Test Java Panama FFI bindings
        uses: ./.github/actions/test-java
        with:
          java-version: ${{ matrix.java }}

  node-bindings:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Setup workspace
        uses: ./.github/actions/setup-node-workspace

      - name: Build NAPI-RS Bindings
        uses: ./.github/actions/build-node

      - name: Test NAPI-RS Bindings
        working-directory: crates/html-to-markdown-node
        run: pnpm test

      - name: Run Rust Tests
        working-directory: crates/html-to-markdown-node
        run: cargo test

      - name: Build TypeScript package
        uses: ./.github/actions/build-typescript

      - name: Test TypeScript package
        working-directory: packages/typescript
        run: pnpm test

  wasm-bindings:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Setup workspace
        uses: ./.github/actions/setup-node-workspace

      - name: Build WASM (all targets)
        uses: ./.github/actions/build-wasm

      - name: Test WASM
        working-directory: crates/html-to-markdown-wasm
        run: pnpm test

      - name: Run Rust Tests
        working-directory: crates/html-to-markdown-wasm
        run: cargo test

  wasm-wasmtime:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown

      - name: Run Wasmtime WASM tests
        run: cargo test -p html-to-markdown-wasm-wasmtime-tests

  smoke:
    name: Smoke README installs
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          check-latest: true

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Setup Ruby
        if: runner.os != 'Windows'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler: "2.7.2"
          bundler-cache: false

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install wasm-pack
        run: |
          set -euo pipefail
          if ! command -v wasm-pack >/dev/null 2>&1; then
            cargo install wasm-pack --locked
          fi

      - name: Setup PHP
        if: runner.os == 'Linux'
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          tools: composer:2.9.1

      - name: Capture php-config path
        if: runner.os == 'Linux'
        run: echo "PHP_CONFIG=$(command -v php-config)" >> "$GITHUB_ENV"

      - name: Install pnpm workspace deps
        run: pnpm install

      - name: Build Node bindings
        id: build_node
        uses: ./.github/actions/build-node
        with:
          pack-tarball: 'true'

      - name: Smoke Node install
        uses: ./.github/actions/smoke-node
        with:
          node-tarball: ${{ steps.build_node.outputs.tarball }}

      - name: Build WASM bundle
        id: build_wasm
        uses: ./.github/actions/build-wasm
        with:
          pack-tarball: 'true'

      - name: Smoke WASM install
        uses: ./.github/actions/smoke-wasm
        with:
          wasm-tarball: ${{ steps.build_wasm.outputs.tarball }}

      - name: Smoke Python install
        uses: ./.github/actions/smoke-python

      - name: Smoke Ruby install
        if: runner.os != 'Windows'
        uses: ./.github/actions/smoke-ruby

      - name: Build PHP extension
        if: runner.os == 'Linux'
        id: build_php
        uses: ./.github/actions/build-php-linux
        with:
          php-config: ${{ env.PHP_CONFIG }}

      - name: Smoke PHP install
        if: runner.os == 'Linux'
        uses: ./.github/actions/smoke-php-linux
        with:
          extension-path: ${{ steps.build_php.outputs.extension-path }}

      - name: Smoke Rust example
        uses: ./.github/actions/smoke-rust

      - name: Smoke Go install
        uses: ./.github/actions/smoke-go

      - name: Smoke C# install
        uses: ./.github/actions/smoke-csharp

  elixir:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.19"
          otp-version: "28.1"

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install Hex/Rebar
        run: |
          mix local.hex --force
          mix local.rebar --force

      - name: Install dependencies
        working-directory: packages/elixir
        run: mix deps.get

      - name: Run tests
        working-directory: packages/elixir
        run: MIX_ENV=test mix test

      - name: Credo lint
        working-directory: packages/elixir
        run: MIX_ENV=dev mix credo --strict
