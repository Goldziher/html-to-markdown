name: Profiling Harness

on:
  push:
    branches: [main]
    paths:
      - crates/**
      - packages/**
      - tools/benchmark-harness/**
      - test_documents/**
      - .github/workflows/profiling.yaml
  workflow_dispatch:
    inputs:
      frameworks:
        description: "Comma-separated frameworks (rust,python,ruby,php,node,wasm,go,java,csharp,elixir)"
        default: "rust"
        required: false
      fixtures:
        description: "Fixture file or directory"
        default: "tools/benchmark-harness/fixtures/wikipedia.toml"
        required: false
      iterations:
        description: "Benchmark iterations per fixture"
        default: "3"
        required: false
      warmup:
        description: "Warmup iterations per fixture"
        default: "1"
        required: false
      mode:
        description: "Benchmark mode (single-file or batch)"
        default: "single-file"
        required: false

permissions:
  contents: read

env:
  DEFAULT_FRAMEWORKS: "rust"
  DEFAULT_FIXTURES: "tools/benchmark-harness/fixtures/wikipedia.toml"
  DEFAULT_ITERATIONS: "3"
  DEFAULT_WARMUP: "1"
  DEFAULT_MODE: "single-file"
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUSTFLAGS: "-g"
  RUST_BACKTRACE: short

jobs:
  profiling:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      FRAMEWORKS: ${{ inputs.frameworks }}
      FIXTURES: ${{ inputs.fixtures }}
      ITERATIONS: ${{ inputs.iterations }}
      WARMUP: ${{ inputs.warmup }}
      MODE: ${{ inputs.mode }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          components: llvm-tools-preview

      - name: Setup Python + uv
        if: contains(env.FRAMEWORKS, 'python')
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Setup Python runtime
        if: contains(env.FRAMEWORKS, 'python')
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install Python deps
        if: contains(env.FRAMEWORKS, 'python')
        run: uv sync --all-extras --no-install-workspace

      - name: Setup Node workspace
        if: contains(env.FRAMEWORKS, 'node') || contains(env.FRAMEWORKS, 'wasm')
        uses: ./.github/actions/setup-node-workspace

      - name: Install wasm-pack
        if: contains(env.FRAMEWORKS, 'wasm')
        run: scripts/common/install-wasm-pack.sh
        shell: bash

      - name: Ensure wasm target installed
        if: contains(env.FRAMEWORKS, 'wasm')
        run: scripts/common/ensure-wasm-target.sh
        shell: bash

      - name: Setup Ruby
        if: contains(env.FRAMEWORKS, 'ruby')
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - name: Install Ruby deps
        if: contains(env.FRAMEWORKS, 'ruby')
        working-directory: packages/ruby
        run: bundle install

      - name: Build Ruby extension
        if: contains(env.FRAMEWORKS, 'ruby')
        working-directory: packages/ruby
        run: bundle exec rake compile

      - name: Setup PHP
        if: contains(env.FRAMEWORKS, 'php')
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          tools: composer:2.9.1
          coverage: none

      - name: Capture php-config path
        if: contains(env.FRAMEWORKS, 'php')
        run: scripts/ci/php/set-php-config.sh
        shell: bash

      - name: Install PHP deps
        if: contains(env.FRAMEWORKS, 'php')
        uses: ramsey/composer-install@v3
        with:
          working-directory: packages/php
          dependency-versions: locked
        env:
          COMPOSER_AUTH: '{"github-oauth":{"github.com":"${{ secrets.GITHUB_TOKEN }}"}}'

      - name: Setup Go
        if: contains(env.FRAMEWORKS, 'go')
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.5"
          check-latest: true

      - name: Setup Java
        if: contains(env.FRAMEWORKS, 'java')
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "25"

      - name: Install Maven
        if: contains(env.FRAMEWORKS, 'java')
        run: sudo apt-get update && sudo apt-get install -y maven

      - name: Setup .NET
        if: contains(env.FRAMEWORKS, 'csharp')
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "9.0.x"

      - name: Setup Elixir
        if: contains(env.FRAMEWORKS, 'elixir')
        uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.19"
          otp-version: "28.1"

      - name: Run benchmark harness
        run: |
          FRAMEWORKS="${FRAMEWORKS:-${DEFAULT_FRAMEWORKS}}"
          FIXTURES="${FIXTURES:-${DEFAULT_FIXTURES}}"
          ITERATIONS="${ITERATIONS:-${DEFAULT_ITERATIONS}}"
          WARMUP="${WARMUP:-${DEFAULT_WARMUP}}"
          MODE="${MODE:-${DEFAULT_MODE}}"
          cargo run --release --features profiling,memory-profiling \
            --manifest-path tools/benchmark-harness/Cargo.toml -- \
            run --fixtures "${FIXTURES}" \
            --frameworks "${FRAMEWORKS}" \
            --iterations "${ITERATIONS}" \
            --warmup "${WARMUP}" \
            --mode "${MODE}" \
            --profile --flamegraphs tools/benchmark-harness/results/flamegraphs \
            --format both --output tools/benchmark-harness/results

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-harness-results
          path: tools/benchmark-harness/results
