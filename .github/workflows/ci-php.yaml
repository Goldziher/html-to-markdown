name: CI PHP

on:
  push:
    branches: [main]
    paths:
      - packages/php/**
      - packages/php-ext/**
      - crates/html-to-markdown-php/**
      - crates/html-to-markdown/**
      - composer.json
      - composer.lock
      - .github/workflows/ci-php.yaml
  pull_request:
    branches: [main]
    paths:
      - packages/php/**
      - packages/php-ext/**
      - crates/html-to-markdown-php/**
      - crates/html-to-markdown/**
      - composer.json
      - composer.lock
      - .github/workflows/ci-php.yaml

concurrency:
  group: ci-php-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  php-bindings:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          tools: composer:2.9.1
          coverage: none

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Capture php-config path
        run: echo "PHP_CONFIG=$(command -v php-config)" >> "$GITHUB_ENV"

      - name: Install Composer dependencies
        uses: ramsey/composer-install@v3
        with:
          working-directory: packages/php
          dependency-versions: locked

      - name: Build PHP extension
        uses: ./.github/actions/build-php-linux
        with:
          php-config: ${{ env.PHP_CONFIG }}

      - name: Run PHP static analysis
        working-directory: packages/php
        run: composer run phpstan

      - name: Run PHP tests
        working-directory: packages/php
        run: composer run test
