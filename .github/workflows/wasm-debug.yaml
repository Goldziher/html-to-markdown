name: wasm-node-debug

on:
  push:
    branches:
      - main
      - "release/*"
  workflow_dispatch:

jobs:
  wasm-dev-smoke:
    name: Debug WASM install on Node
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: |
          if ! command -v wasm-pack >/dev/null 2>&1; then
            cargo install wasm-pack --locked
          fi

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          check-latest: true

      - name: Enable corepack
        run: corepack enable

      - name: Install workspace deps
        run: pnpm install --filter html-to-markdown-wasm...

      - name: Build wasm bundle
        run: pnpm --filter html-to-markdown-wasm run build:all

      - name: Pack WASM package
        run: |
          set -euo pipefail
          cd crates/html-to-markdown-wasm
          npm pack >/dev/null
          mv html-to-markdown-wasm-*.tgz "$GITHUB_WORKSPACE/html-to-markdown-wasm.tgz"

      - name: Run WASM smoke test
        run: |
          set -euo pipefail
          tmp=$(mktemp -d)
          rsync -a examples/wasm-smoke/ "$tmp"/
          pushd "$tmp" >/dev/null
          cp "$GITHUB_WORKSPACE/html-to-markdown-wasm.tgz" ./wasm.tgz
          node -e "const fs=require('fs');const pkg=JSON.parse(fs.readFileSync('package.json','utf8'));pkg.dependencies=pkg.dependencies||{};pkg.dependencies['html-to-markdown-wasm']='file:./wasm.tgz';fs.writeFileSync('package.json',JSON.stringify(pkg,null,2)+ '\n');"
          rm -f pnpm-lock.yaml
          pnpm install --no-frozen-lockfile
          pnpm run check
          popd >/dev/null
