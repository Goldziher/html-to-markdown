name: Publish Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to build (e.g., v2.6.0)"
        required: true
        type: string
      dry_run:
        description: "Prepare artifacts without publishing"
        required: false
        type: boolean
        default: false
      ref:
        description: "Git ref (branch, tag, or commit) to build; defaults to the tag"
        required: false
        type: string
  release:
    types: [published]
  repository_dispatch:
    types: [publish-release]

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ (github.event_name == 'workflow_dispatch' && (github.event.inputs.ref || github.event.inputs.tag)) || github.ref || github.run_id }}
  cancel-in-progress: false

jobs:
  prepare:
    name: Prepare metadata
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      version: ${{ steps.meta.outputs.version }}
      ref: ${{ steps.meta.outputs.ref }}
      dry_run: ${{ steps.meta.outputs.dry_run }}
      checkout_ref: ${{ steps.meta.outputs.checkout_ref }}
      target_sha: ${{ steps.meta.outputs.target_sha }}
      matrix_ref: ${{ steps.meta.outputs.matrix_ref }}
      is_tag: ${{ steps.meta.outputs.is_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref || inputs.tag || github.ref }}
          fetch-depth: 0

      - name: Validate tag and compute version
        id: meta
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          INPUT_TAG: ${{ inputs.tag }}
          INPUT_DRY_RUN: ${{ inputs.dry_run }}
          INPUT_REF: ${{ inputs.ref }}
          EVENT_RELEASE_TAG: ${{ github.event.release.tag_name }}
          EVENT_DISPATCH_TAG: ${{ github.event.client_payload.tag }}
          EVENT_DISPATCH_DRY_RUN: ${{ github.event.client_payload.dry_run }}
          EVENT_DISPATCH_REF: ${{ github.event.client_payload.ref }}
        run: scripts/publish/validate-and-compute-metadata.sh
      - name: Upload release metadata
        uses: actions/upload-artifact@v5
        with:
          name: release-metadata
          path: release-metadata.json
          retention-days: 14

  check-pypi:
    name: Check PyPI for existing version
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Check PyPI version
        id: check
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/check-pypi-version.sh

  check-npm:
    name: Check npm for existing versions
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      node_exists: ${{ steps.check.outputs.node_exists }}
      wasm_exists: ${{ steps.check.outputs.wasm_exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Check npm packages
        id: check
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/check-npm-packages.sh

  check-rubygems:
    name: Check RubyGems for existing version
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Check RubyGems version
        id: check
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/check-rubygems-version.sh

  check-hex:
    name: Check Hex.pm for existing version
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Check Hex version
        id: check
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/elixir/check-hex-version.sh

  check-maven:
    name: Check Maven Central for existing version
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Check Maven version
        id: check
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/check-maven-version.sh

  check-nuget:
    name: Check NuGet for existing version
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Check NuGet package
        id: check
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/check-nuget-version.sh

  check-cratesio:
    name: Check crates.io for existing versions
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      rs_exists: ${{ steps.check.outputs.rs_exists }}
      cli_exists: ${{ steps.check.outputs.cli_exists }}
      all_exist: ${{ steps.check.outputs.all_exist }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Query crates.io
        id: check
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/check-cratesio-versions.sh

  check-homebrew:
    name: Check Homebrew tap for existing version
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Check Homebrew formula version
        id: check
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/homebrew/check-homebrew-version.sh

  python-wheels:
    name: Build Python wheels (${{ matrix.os }})
    needs: prepare
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Build wheels
        uses: ./.github/actions/build-wheels
        with:
          python-version: "3.13"

      - name: Upload wheels
        uses: actions/upload-artifact@v5
        with:
          name: python-wheels-${{ matrix.os }}
          path: wheelhouse/*.whl
          retention-days: 14

  python-sdist:
    name: Build Python sdist
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install build dependencies
        run: scripts/publish/python/install-build-deps.sh
        shell: bash

      - name: Build CLI binary for sdist
        run: scripts/publish/python/build-cli-for-sdist.sh
        shell: bash

      - name: Prepare sdist with CLI
        run: scripts/publish/python/prepare-sdist-with-cli.sh
        shell: bash

      - name: Build sdist
        run: scripts/publish/python/build-sdist.sh
        shell: bash

      - name: Upload sdist
        uses: actions/upload-artifact@v5
        with:
          name: python-sdist
          path: packages/python/dist/*.tar.gz
          retention-days: 14

  php-pie:
    name: Build PHP PIE source bundle
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer:2.9.1
          coverage: none

      - name: Ensure packaging script is executable
        run: scripts/publish/php/ensure-package-script-executable.sh
        shell: bash

      - name: Assemble PIE source archive
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/php/assemble-pie-archive.sh
        shell: bash

      - name: Download PIE CLI
        run: scripts/publish/php/download-pie-cli.sh
        shell: bash

      - name: Verify PIE build from archive
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/php/verify-pie-archive.sh
        shell: bash

      - name: Upload PIE source archive
        uses: actions/upload-artifact@v5
        with:
          name: php-pie-src
          path: build/artifacts/php_html_to_markdown-${{ needs.prepare.outputs.version }}-src.tgz
          retention-days: 14

  node-typescript-defs:
    name: Generate Node TypeScript definitions
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          check-latest: true

      - name: Enable corepack
        run: scripts/common/enable-corepack.sh
        shell: bash

      - name: Install Node dependencies
        run: scripts/publish/node/install-node-deps.sh
        shell: bash

      - name: Generate TypeScript definitions
        run: scripts/publish/node/generate-typescript-defs.sh
        shell: bash

      - name: Upload TypeScript definitions
        uses: actions/upload-artifact@v5
        with:
          name: node-typescript-defs
          path: typescript-defs/
          retention-days: 14

  node-bindings:
    name: Build Node bindings (${{ matrix.target }})
    needs: prepare
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            target: aarch64-apple-darwin
            rust_target: ""
            use_cross: false
            use_napi_cross: false
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            rust_target: ""
            use_cross: false
            use_napi_cross: false
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            rust_target: x86_64-unknown-linux-musl
            use_cross: true
            use_napi_cross: false
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            rust_target: aarch64-unknown-linux-gnu
            use_cross: false
            use_napi_cross: true
          - os: ubuntu-latest
            target: aarch64-unknown-linux-musl
            rust_target: aarch64-unknown-linux-musl
            use_cross: true
            use_napi_cross: false
          - os: ubuntu-latest
            target: armv7-unknown-linux-gnueabihf
            rust_target: armv7-unknown-linux-gnueabihf
            use_cross: false
            use_napi_cross: true
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            rust_target: ""
            use_cross: false
            use_napi_cross: false
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            rust_target: aarch64-pc-windows-msvc
            use_cross: false
            use_napi_cross: false
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust target
        if: ${{ matrix.rust_target != '' }}
        env:
          RUST_TARGET: ${{ matrix.rust_target }}
        run: scripts/publish/common/add-rust-target.sh
        shell: bash

      - name: Install cross
        if: ${{ matrix.use_cross }}
        run: scripts/publish/cli/install-cross.sh
        shell: bash

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          check-latest: true

      - name: Enable corepack
        run: scripts/common/enable-corepack.sh
        shell: bash

      - name: Install Node dependencies
        run: scripts/publish/node/install-node-deps.sh
        shell: bash

      - name: Clean npm directory
        if: runner.os != 'Windows'
        run: scripts/publish/node/clean-npm-dir.sh
        shell: bash

      - name: Clean npm directory (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: scripts/publish/node/clean-npm-dir.ps1

      - name: Create npm package structure
        run: scripts/publish/node/create-npm-package-structure.sh
        shell: bash

      - name: Build native module
        if: runner.os != 'Windows'
        env:
          TARGET: ${{ matrix.target }}
          USE_CROSS: ${{ matrix.use_cross }}
          USE_NAPI_CROSS: ${{ matrix.use_napi_cross }}
        shell: bash
        run: scripts/publish/node/build-native-module.sh

      - name: Build native module (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          TARGET: ${{ matrix.target }}
          USE_CROSS: ${{ matrix.use_cross }}
          USE_NAPI_CROSS: ${{ matrix.use_napi_cross }}
        run: scripts/publish/node/build-native-module.ps1

      - name: Package artifacts
        if: runner.os != 'Windows'
        env:
          TARGET: ${{ matrix.target }}
        run: scripts/publish/node/package-artifacts.sh
        shell: bash

      - name: Package artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          TARGET: ${{ matrix.target }}
        run: scripts/publish/node/package-artifacts.ps1

      - name: Upload Node artifact
        uses: actions/upload-artifact@v5
        with:
          name: node-bindings-${{ matrix.target }}
          path: node-bindings-${{ matrix.target }}.tar.gz
          retention-days: 14

  wasm-bindings:
    name: Build WASM bindings
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Add wasm32 target
        run: scripts/common/ensure-wasm-target.sh
        shell: bash

      - name: Install wasm-pack
        run: scripts/common/install-wasm-pack.sh
        shell: bash

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          check-latest: true

      - name: Enable corepack
        run: scripts/common/enable-corepack.sh
        shell: bash

      - name: Install dependencies
        run: scripts/publish/wasm/install-deps.sh
        shell: bash

      - name: Build WASM bundles
        run: scripts/publish/wasm/build-bundles.sh
        shell: bash

      - name: Package WASM artifacts
        run: scripts/publish/wasm/package-artifacts.sh
        shell: bash

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v5
        with:
          name: wasm-bundles
          path: wasm-artifacts/*
          retention-days: 14

  cli-binaries:
    name: Build CLI binaries (${{ matrix.target }})
    needs: prepare
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            use_cross: false
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            use_cross: false
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            use_cross: false
          - os: macos-14
            target: aarch64-apple-darwin
            use_cross: false
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            use_cross: false
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Add compilation target
        env:
          RUST_TARGET: ${{ matrix.target }}
        run: scripts/publish/common/add-rust-target.sh
        shell: bash

      - name: Install build dependencies
        if: runner.os == 'Linux'
        env:
          TARGET: ${{ matrix.target }}
        run: scripts/publish/cli/install-build-deps-linux.sh
        shell: bash

      - name: Configure cross linker
        if: ${{ matrix.target == 'aarch64-unknown-linux-gnu' }}
        env:
          TARGET: ${{ matrix.target }}
        run: scripts/publish/cli/configure-cross-linker.sh
        shell: bash

      - name: Install cross
        if: ${{ matrix.use_cross }}
        run: scripts/publish/cli/install-cross.sh
        shell: bash

      - name: Build CLI
        shell: bash
        env:
          TARGET: ${{ matrix.target }}
          USE_CROSS: ${{ matrix.use_cross }}
        run: scripts/publish/cli/build-cli.sh

      - name: Package CLI artifact
        if: runner.os != 'Windows'
        shell: bash
        env:
          TARGET: ${{ matrix.target }}
        run: scripts/publish/cli/package-cli-artifact.sh

      - name: Package CLI artifact (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          TARGET: ${{ matrix.target }}
        run: scripts/publish/cli/package-cli-artifact.ps1

      - name: Upload CLI artifact
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@v5
        with:
          name: cli-${{ matrix.target }}
          path: cli-${{ matrix.target }}.tar.gz
          retention-days: 14

      - name: Upload CLI artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v5
        with:
          name: cli-${{ matrix.target }}
          path: cli-${{ matrix.target }}.zip
          retention-days: 14

  release-smoke:
    name: Smoke release artifacts (${{ matrix.os }})
    needs:
      - prepare
      - python-wheels
      - python-sdist
      - php-pie
      - node-typescript-defs
      - node-bindings
      - wasm-bindings
      - cli-binaries
      - ruby-gem
      - elixir-package
      - cargo-packages
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Download Python wheels
        uses: actions/download-artifact@v6
        with:
          name: python-wheels-${{ matrix.os }}
          path: python-wheels

      - name: Determine Ruby artifact label
        id: ruby_label
        env:
          MATRIX_OS: ${{ matrix.os }}
        run: scripts/publish/smoke/determine-ruby-artifact-label.sh
        shell: bash

      - name: Download Ruby gems
        uses: actions/download-artifact@v6
        with:
          name: rubygems-${{ steps.ruby_label.outputs.label }}
          path: ruby-gems

      - name: Download Elixir package
        uses: actions/download-artifact@v6
        with:
          name: elixir-hex-package
          path: elixir-package

      - name: Inspect Elixir package
        run: scripts/publish/smoke/inspect-elixir-package.sh
        shell: bash

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Setup Ruby
        if: runner.os != 'Windows'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: false

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Setup PHP
        if: runner.os == 'Linux'
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          tools: composer:2.9.1

      - name: Capture php-config path
        if: runner.os == 'Linux'
        run: scripts/ci/smoke/capture-php-config.sh
        shell: bash

      - name: Smoke Python install
        uses: ./.github/actions/smoke-python

      - name: Smoke Ruby install
        if: runner.os != 'Windows'
        uses: ./.github/actions/smoke-ruby

      - name: Build PHP extension
        if: runner.os == 'Linux'
        id: build_php_smoke
        uses: ./.github/actions/build-php-linux
        with:
          php-config: ${{ env.PHP_CONFIG }}

      - name: Smoke PHP install
        if: runner.os == 'Linux'
        uses: ./.github/actions/smoke-php-linux
        with:
          extension-path: ${{ steps.build_php_smoke.outputs.extension-path }}

      - name: Smoke Rust example
        uses: ./.github/actions/smoke-rust

      - name: Smoke Go install
        uses: ./.github/actions/smoke-go

      - name: Smoke C# install
        uses: ./.github/actions/smoke-csharp

      - name: Download CLI artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: cli-*
          path: cli-artifacts
          merge-multiple: false

      - name: Download PHP PIE artifacts
        if: runner.os == 'Linux'
        uses: actions/download-artifact@v6
        with:
          name: php-pie-src
          path: php-pie-artifacts

      - name: Smoke CLI binary
        uses: ./.github/actions/smoke-cli
        with:
          cli-artifacts-dir: ${{ github.workspace }}/cli-artifacts

      - name: Smoke PIE install (Linux)
        if: runner.os == 'Linux'
        uses: ./.github/actions/smoke-pie
        with:
          pie-artifacts-dir: ${{ github.workspace }}/php-pie-artifacts

  smoke-java:
    name: Smoke Java install
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Maven 3.9.9
        shell: bash
        run: |
          set -euo pipefail
          MAVEN_VERSION=3.9.9
          # Normalize paths on Windows to avoid tar interpreting "D:" as a host
          if [[ "${RUNNER_OS:-}" == "Windows" ]]; then
            TMP_DIR="$(cygpath -u "${RUNNER_TEMP}")"
          else
            TMP_DIR="${RUNNER_TEMP}"
          fi
          MAVEN_DIR="${TMP_DIR}/apache-maven-${MAVEN_VERSION}"
          if [[ ! -d "${MAVEN_DIR}" ]]; then
            curl -sL "https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/${MAVEN_VERSION}/apache-maven-${MAVEN_VERSION}-bin.tar.gz" -o "${TMP_DIR}/maven.tar.gz"
            tar -xzf "${TMP_DIR}/maven.tar.gz" -C "${TMP_DIR}"
          fi
          echo "${MAVEN_DIR}/bin" >> "${GITHUB_PATH}"

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "25"
          cache: maven

      - name: Smoke Java install
        uses: ./.github/actions/smoke-java

  ruby-gem:
    name: Build Ruby gem (${{ matrix.label }})
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            label: linux
          - os: macos-14
            label: macos-arm64
          - os: windows-latest
            label: windows-x64
    runs-on: ${{ matrix.os }}
    env:
      RB_SYS_CARGO_PROFILE: release
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Remove cached CLI binaries
        shell: bash
        run: scripts/publish/ruby/remove-cached-cli.sh

      - name: Install MSYS2 toolchain
        if: runner.os == 'Windows'
        shell: pwsh
        run: scripts/publish/ruby/install-msys2-toolchain.ps1

      - name: Install Rust (GNU on Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: scripts/publish/ruby/install-rust-gnu.ps1

      - name: Configure bindgen sysroot (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: scripts/publish/ruby/configure-bindgen-windows.sh

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler: "2.7.2"
          bundler-cache: false

      - name: Install Ruby dependencies (Unix)
        if: runner.os != 'Windows'
        run: scripts/publish/ruby/install-deps-unix.sh
        shell: bash

      - name: Install Ruby dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: scripts/publish/ruby/install-deps-windows.ps1

      - name: Build gem artifacts (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: scripts/publish/ruby/build-gem-unix.sh

      - name: Build gem artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: scripts/publish/ruby/build-gem-windows.ps1

      - name: Verify gem artifacts
        shell: bash
        run: scripts/publish/ruby/verify-gem-artifacts.sh

      - name: Upload gem artifacts
        uses: actions/upload-artifact@v5
        with:
          name: rubygems-${{ matrix.label }}
          path: packages/ruby/pkg/*.gem
          retention-days: 14

  elixir-package:
    name: Build Elixir Hex package
    needs: prepare
    runs-on: ubuntu-latest
    env:
      MIX_ENV: dev
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.19"
          otp-version: "28.1"

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Install Hex and Rebar
        run: scripts/publish/elixir/install-hex-rebar.sh
        shell: bash

      - name: Install dependencies
        run: scripts/publish/elixir/install-deps.sh
        shell: bash

      - name: Run Elixir tests
        run: scripts/publish/elixir/run-tests.sh
        shell: bash

      - name: Build Hex package
        run: scripts/publish/elixir/build-hex-package.sh
        shell: bash

      - name: Upload Hex artifact
        uses: actions/upload-artifact@v5
        with:
          name: elixir-hex-package
          path: packages/elixir/html_to_markdown-*.tar
          retention-days: 14

  csharp-package:
    name: Build C# NuGet package
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "8.0.x"

      - name: Install dependencies
        run: scripts/publish/csharp/restore.sh packages/csharp/HtmlToMarkdown/HtmlToMarkdown.csproj
        shell: bash

      - name: Pack NuGet package
        run: scripts/publish/csharp/pack.sh
        shell: bash

      - name: Upload NuGet artifact
        uses: actions/upload-artifact@v5
        with:
          name: csharp-nuget
          path: artifacts/csharp/*.nupkg
          retention-days: 14

  cargo-packages:
    name: Package Rust crates
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Package crates
        env:
          RELEASE_VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/crates/package-crates.sh
        shell: bash

      - name: Upload crate packages
        uses: actions/upload-artifact@v5
        with:
          name: cargo-crates
          path: crate-artifacts/*.crate
          retention-days: 14

  upload-release-artifacts:
    name: Upload Release Artifacts
    needs: [prepare, python-wheels, python-sdist, php-pie, node-typescript-defs, node-bindings, wasm-bindings, cli-binaries, ruby-gem, elixir-package, cargo-packages, release-smoke]
    if: ${{ needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Download PHP PIE artifact
        uses: actions/download-artifact@v6
        with:
          name: php-pie-src
          path: dist/php-pie

      - name: Download CLI artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: cli-*
          path: dist/cli
          merge-multiple: false

      - name: Download Elixir package
        uses: actions/download-artifact@v6
        with:
          name: elixir-hex-package
          path: dist/elixir

      - name: Upload PHP PIE source bundle
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.prepare.outputs.tag }}
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/upload-php-pie.sh
        shell: bash

      - name: Upload CLI binaries
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.prepare.outputs.tag }}
        run: scripts/publish/upload-cli-artifacts.sh
        shell: bash

      - name: Upload Elixir package
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.prepare.outputs.tag }}
        run: scripts/publish/upload-elixir-package.sh
        shell: bash

  publish-crates:
    name: Publish crates.io packages
    needs: [prepare, upload-release-artifacts, check-cratesio]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' && needs.check-cratesio.outputs.all_exist != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Verify Cargo.toml version matches tag
        env:
          TAG_VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/crates/verify-cargo-version.sh
        shell: bash

      - name: Publish html-to-markdown-rs
        if: ${{ needs.check-cratesio.outputs.rs_exists != 'true' }}
        env:
          CARGO_TOKEN: ${{ secrets.CARGO_TOKEN }}
        run: scripts/publish/crates/publish-rs.sh
        shell: bash

      - name: Wait for indexing
        if: ${{ needs.check-cratesio.outputs.rs_exists != 'true' }}
        run: scripts/publish/crates/wait-for-indexing.sh
        shell: bash

      - name: Publish html-to-markdown-cli
        if: ${{ needs.check-cratesio.outputs.cli_exists != 'true' }}
        env:
          CARGO_TOKEN: ${{ secrets.CARGO_TOKEN }}
        run: scripts/publish/crates/publish-cli.sh
        shell: bash

  publish-pypi:
    name: Publish Python packages to PyPI
    needs: [prepare, upload-release-artifacts, check-pypi]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' && needs.check-pypi.outputs.exists != 'true' }}
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Download wheel artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: python-wheels-*
          path: dist
          merge-multiple: true

      - name: Download sdist artifact
        uses: actions/download-artifact@v6
        with:
          name: python-sdist
          path: dist

      - name: List artifacts
        run: scripts/publish/python/list-dist.sh
        shell: bash

      - name: Publish to PyPI
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
          skip-existing: true

  publish-rubygems:
    name: Publish Ruby gems
    needs: [prepare, upload-release-artifacts, check-rubygems]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.is_tag == 'true' && (needs.prepare.outputs.dry_run == 'true' || needs.check-rubygems.outputs.exists != 'true') }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Download Ruby gem artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: rubygems-*
          path: dist
          merge-multiple: true

      - name: Configure trusted publishing credentials
        if: ${{ needs.prepare.outputs.dry_run != 'true' && needs.check-rubygems.outputs.exists != 'true' }}
        uses: rubygems/configure-rubygems-credentials@v1.0.0

      - name: Publish gems
        if: ${{ needs.prepare.outputs.dry_run != 'true' && needs.check-rubygems.outputs.exists != 'true' }}
        working-directory: dist
        run: ../scripts/publish/ruby/publish-gems.sh
        shell: bash

      - name: Ruby gem already published
        if: ${{ needs.check-rubygems.outputs.exists == 'true' && needs.prepare.outputs.dry_run != 'true' }}
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/ruby/already-published-summary.sh
        shell: bash

  publish-hex:
    name: Publish Hex package
    needs: [prepare, elixir-package, upload-release-artifacts, check-hex]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' && needs.check-hex.outputs.exists != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.19"
          otp-version: "28.1"

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Install Hex/Rebar
        run: scripts/publish/elixir/install-hex-rebar.sh
        shell: bash

      - name: Install dependencies
        run: scripts/publish/elixir/install-deps.sh
        shell: bash

      - name: Check Hex version
        id: hex_check
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/elixir/check-hex-version.sh
        shell: bash

      - name: Publish to Hex.pm
        if: ${{ steps.hex_check.outputs.exists != 'true' }}
        run: scripts/publish/elixir/publish-hex.sh
        shell: bash
        env:
          HEX_API_KEY: ${{ secrets.HEX_TOKEN }}

      - name: Hex package already published
        if: ${{ steps.hex_check.outputs.exists == 'true' }}
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/elixir/already-published-summary.sh
        shell: bash

  publish-nuget:
    name: Publish NuGet package
    needs: [prepare, csharp-package, upload-release-artifacts, check-nuget]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' && needs.check-nuget.outputs.exists != 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "8.0.x"

      - name: NuGet login (OIDC â†’ temp API key)
        id: nuget-login
        uses: NuGet/login@v1
        with:
          user: "nhirschfeld"

      - name: Download NuGet artifact
        uses: actions/download-artifact@v6
        with:
          name: csharp-nuget
          path: dist/nuget

      - name: Publish package to NuGet.org
        env:
          DOTNET_NOLOGO: true
          NUGET_API_KEY: ${{ steps.nuget-login.outputs.NUGET_API_KEY }}
        run: scripts/publish/nuget/publish-packages.sh
        shell: bash

  publish-maven:
    name: Publish Maven package
    needs: [prepare, upload-release-artifacts, check-maven]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' && needs.check-maven.outputs.exists != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Verify Central credentials
        shell: bash
        run: |
          : "${MAVEN_USERNAME:?Set MAVEN_USERNAME to your Sonatype Central token user (namecode)}"
          : "${MAVEN_PASSWORD:?Set MAVEN_PASSWORD to your Sonatype Central token password}"

      - name: Install Maven 3.9.9
        shell: bash
        run: |
          set -euo pipefail
          MAVEN_VERSION=3.9.9
          if [[ "${RUNNER_OS:-}" == "Windows" ]]; then
            TMP_DIR="$(cygpath -u "${RUNNER_TEMP}")"
          else
            TMP_DIR="${RUNNER_TEMP}"
          fi
          MAVEN_DIR="${TMP_DIR}/apache-maven-${MAVEN_VERSION}"
          if [[ ! -d "${MAVEN_DIR}" ]]; then
            curl -sL "https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/${MAVEN_VERSION}/apache-maven-${MAVEN_VERSION}-bin.tar.gz" -o "${TMP_DIR}/maven.tar.gz"
            tar -xzf "${TMP_DIR}/maven.tar.gz" -C "${TMP_DIR}"
          fi
          echo "${MAVEN_DIR}/bin" >> "${GITHUB_PATH}"

      - name: Patch legacy Maven GPG arguments
        run: scripts/publish/maven/patch-legacy-gpg-args.sh
        shell: bash

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "25"
          cache: maven
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: ${{ secrets.GPP_PASSPHRASE }}

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Prefer gpg2 binary
        run: scripts/publish/maven/prefer-gpg2.sh
        shell: bash

      - name: Release Maven package
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPP_PASSPHRASE }}
          GPG: /usr/bin/gpg2
        run: scripts/publish/maven/release-package.sh
        shell: bash

  publish-node:
    name: Publish Node packages
    needs: [prepare, upload-release-artifacts, check-npm]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' && needs.check-npm.outputs.node_exists != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Download Node artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: node-bindings-*
          path: node-artifacts
          merge-multiple: true

      - name: Download TypeScript definitions
        uses: actions/download-artifact@v6
        with:
          name: node-typescript-defs
          path: typescript-defs

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/

      - name: Enable corepack
        run: scripts/common/enable-corepack.sh
        shell: bash

      - name: Prepare artifact directory
        run: scripts/publish/node/prepare-artifact-directory.sh
        shell: bash

      - name: Install workspace dependencies
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        run: scripts/publish/node/install-node-deps.sh
        shell: bash

      - name: Pack platform packages
        run: scripts/publish/node/pack-platform-packages.sh
        shell: bash

      - name: Publish native binary packages
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: scripts/publish/node/publish-native-packages.sh
        shell: bash

      - name: Publish main Node package
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        working-directory: crates/html-to-markdown-node
        run: ../../scripts/publish/node/publish-main-package.sh
        shell: bash

  publish-wasm:
    name: Publish WASM package
    needs: [prepare, upload-release-artifacts, check-npm]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' && needs.check-npm.outputs.wasm_exists != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Download WASM artifacts
        uses: actions/download-artifact@v6
        with:
          name: wasm-bundles
          path: wasm-artifacts

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/

      - name: Extract WASM artifacts
        run: scripts/publish/wasm/extract-artifacts.sh
        shell: bash

      - name: Publish WASM package
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        working-directory: crates/html-to-markdown-wasm
        run: ../../scripts/publish/wasm/publish-package.sh
        shell: bash

  publish-homebrew:
    name: Update Homebrew formula
    needs: [prepare, upload-release-artifacts, check-homebrew]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' && needs.check-homebrew.outputs.exists != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Extract release info
        id: release
        env:
          TAG: ${{ needs.prepare.outputs.tag }}
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/homebrew/extract-release-info.sh
        shell: bash

      - name: Update Homebrew formula
        uses: mislav/bump-homebrew-formula-action@v3
        with:
          formula-name: html-to-markdown
          formula-path: Formula/html-to-markdown.rb
          homebrew-tap: Goldziher/homebrew-tap
          tag-name: ${{ needs.prepare.outputs.tag }}
          download-url: ${{ steps.release.outputs.url }}
          commit-message: |
            chore(homebrew): update html-to-markdown to ${{ steps.release.outputs.version }}

            Auto-update from release ${{ steps.release.outputs.tag }}
        env:
          COMMITTER_TOKEN: ${{ secrets.HOMEBREW_TOKEN }}
