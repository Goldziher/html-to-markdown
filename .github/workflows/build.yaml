name: Build Artifacts

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to build (e.g., v2.6.0)"
        required: true
        type: string
      dry_run:
        description: "Prepare artifacts without publishing"
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.event.inputs.tag || github.run_id }}
  cancel-in-progress: false

jobs:
  prepare:
    name: Prepare metadata
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      version: ${{ steps.meta.outputs.version }}
      ref: ${{ steps.meta.outputs.ref }}
      dry_run: ${{ steps.meta.outputs.dry_run }}
    steps:
      - name: Validate tag and compute version
        id: meta
        run: |
          tag="${{ inputs.tag }}"
          if [[ -z "$tag" ]]; then
            echo "Tag input is required" >&2
            exit 1
          fi
          if [[ "$tag" != v* ]]; then
            echo "Tag must start with 'v' (e.g., v2.6.0)" >&2
            exit 1
          fi
          version="${tag#v}"
          ref="refs/tags/${tag}"
          dry_run="${{ inputs.dry_run }}"
          cat <<JSON > release-metadata.json
          {
            "tag": "$tag",
            "version": "$version",
            "ref": "$ref",
            "dry_run": ${dry_run:-false}
          }
          JSON
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "ref=$ref" >> "$GITHUB_OUTPUT"
          echo "dry_run=${dry_run:-false}" >> "$GITHUB_OUTPUT"
      - name: Upload release metadata
        uses: actions/upload-artifact@v4
        with:
          name: release-metadata
          path: release-metadata.json
          retention-days: 14

  python-wheels:
    name: Build Python wheels (${{ matrix.os }})
    needs: prepare
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Build wheels
        uses: ./.github/actions/build-wheels
        with:
          python-version: "3.13"

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: python-wheels-${{ matrix.os }}
          path: wheelhouse/*.whl
          retention-days: 14

  python-sdist:
    name: Build Python sdist
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install maturin

      - name: Build CLI binary for sdist
        run: cargo build --release --package html-to-markdown-cli

      - name: Prepare sdist with CLI
        run: python scripts/prepare_wheel.py

      - name: Build sdist
        working-directory: packages/python
        run: maturin sdist --out dist/

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: python-sdist
          path: packages/python/dist/*.tar.gz
          retention-days: 14

  php-pie:
    name: Build PHP PIE source bundle
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          coverage: none
          tools: none

      - name: Ensure packaging script is executable
        run: chmod +x scripts/package_php_pie_source.sh

      - name: Assemble PIE source archive
        run: ./scripts/package_php_pie_source.sh ${{ needs.prepare.outputs.version }} build/artifacts

      - name: Download PIE CLI
        run: |
          curl -fsSL https://github.com/php/pie/releases/latest/download/pie.phar -o build/pie.phar

      - name: Verify PIE build from archive
        run: |
          set -euo pipefail
          TMP_DIR=$(mktemp -d)
          tar -xzf build/artifacts/php_html_to_markdown-${{ needs.prepare.outputs.version }}-src.tgz -C "$TMP_DIR"
          php build/pie.phar repository:add path "$TMP_DIR"
          php build/pie.phar build html-to-markdown/html-to-markdown-ext:*@dev --with-cargo-bin=$(command -v cargo)

      - name: Upload PIE source archive
        uses: actions/upload-artifact@v4
        with:
          name: php-pie-src
          path: build/artifacts/php_html_to_markdown-${{ needs.prepare.outputs.version }}-src.tgz
          retention-days: 14

  php-windows-matrix:
    name: Resolve Windows build matrix
    needs: prepare
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Compute Windows matrix
        id: matrix
        uses: php/php-windows-builder/extension-matrix@v1
        with:
          extension-url: https://github.com/${{ github.repository }}
          extension-ref: ${{ needs.prepare.outputs.ref }}

  php-windows:
    name: Build PHP extension (Windows)
    needs: [prepare, php-pie, php-windows-matrix]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.php-windows-matrix.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Download PIE source snapshot
        uses: actions/download-artifact@v4
        with:
          name: php-pie-src
          path: tmp/pie-src

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Expand workspace snapshot
        shell: pwsh
        run: |
          $archive = Get-ChildItem -Path "tmp/pie-src" -Filter "php_html_to_markdown-*-src.tgz" | Select-Object -First 1
          if ($null -eq $archive) {
            Write-Error "PIE source archive not found"
            exit 1
          }
          $workspace = Join-Path $PWD "packages\php-ext\workspace"
          if (Test-Path $workspace) {
            Remove-Item $workspace -Recurse -Force
          }
          New-Item -ItemType Directory -Path $workspace | Out-Null
          tar -xf $archive.FullName -C $workspace

      - name: Build Windows artifacts
        uses: php/php-windows-builder/extension@v1
        env:
          GITHUB_ACTIONS: 'false'
        with:
          php-version: ${{ matrix.php-version }}
          arch: ${{ matrix.arch }}
          ts: ${{ matrix.ts }}
          args: --enable-html_to_markdown
          run-tests: 'false'

  ruby-gem:
    name: Build Ruby gem (${{ matrix.label }})
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            label: linux
          - os: macos-14
            label: macos-arm64
          - os: macos-13
            label: macos-x86_64
          - os: windows-latest
            label: windows-x64
    runs-on: ${{ matrix.os }}
    env:
      RB_SYS_CARGO_PROFILE: release
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ needs.prepare.outputs.ref }}
          fetch-depth: 0

      - name: Remove cached CLI binaries
        shell: bash
        run: rm -f packages/ruby/lib/bin/html-to-markdown*

      - name: Install MSYS2 toolchain
        if: runner.os == 'Windows'
        shell: pwsh
        run: ridk exec pacman -S --needed --noconfirm base-devel mingw-w64-ucrt-x86_64-toolchain

      - name: Install Rust (GNU on Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: rustup toolchain install stable-gnu --profile minimal --no-self-update

      - name: Configure bindgen sysroot (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: echo "BINDGEN_EXTRA_CLANG_ARGS=--target=x86_64-pc-windows-gnu --sysroot=${RI_DEVKIT//\\/\/}$MSYSTEM_PREFIX" >> "$GITHUB_ENV"

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler: "2.5.12"
          bundler-cache: false

      - name: Install Ruby dependencies (Unix)
        if: runner.os != 'Windows'
        run: bundle _2.5.12_ install --jobs 4 --retry 3
        working-directory: packages/ruby

      - name: Install Ruby dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $workspace = ridk exec bash -lc "cygpath -au '$env:GITHUB_WORKSPACE'"
          $gemdir = "$workspace/packages/ruby"
          ridk exec bash -lc "cd $gemdir && export RUSTUP_TOOLCHAIN=stable-gnu CC=x86_64-w64-mingw32-gcc CXX=x86_64-w64-mingw32-g++ && bundle _2.5.12_ install --jobs 4 --retry 3"

      - name: Build gem artifacts (Unix)
        if: runner.os != 'Windows'
        shell: bash
        working-directory: packages/ruby
        run: |
          set -euo pipefail
          bundle _2.5.12_ exec rake clean
          ruby ../../scripts/prepare_ruby_gem.rb
          bundle _2.5.12_ exec rake build

      - name: Build gem artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $workspace = ridk exec bash -lc "cygpath -au '$env:GITHUB_WORKSPACE'"
          $gemdir = "$workspace/packages/ruby"
          ridk exec bash -lc "cd $workspace && export RUSTUP_TOOLCHAIN=stable-gnu && ruby scripts/prepare_ruby_gem.rb"
          ridk exec bash -lc "cd $gemdir && export RUSTUP_TOOLCHAIN=stable-gnu CC=x86_64-w64-mingw32-gcc CXX=x86_64-w64-mingw32-g++ && bundle _2.5.12_ exec rake clean && bundle _2.5.12_ exec rake build"

      - name: Verify gem artifacts
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(packages/ruby/pkg/*.gem)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No gems were produced" >&2
            exit 1
          fi

      - name: Upload gem artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rubygems-${{ matrix.label }}
          path: packages/ruby/pkg/*.gem
          retention-days: 14
