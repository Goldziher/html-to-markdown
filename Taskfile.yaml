version: "3"

vars:
  RUST_LOG: info

silent: false

tasks:
  setup:
    desc: "Install all language dependencies and build the Rust core"
    cmds:
      - task: python:install
      - task: js:install
      - task: ruby:install
      - task: rust:build

  update:
    desc: "Update dependencies across Rust, JavaScript, Python, and Ruby"
    cmds:
      - echo "Updating Rust crates..."
      - cargo upgrade --incompatible
      - cargo update
      - echo "Updating JavaScript packages..."
      - pnpm up --latest -r
      - echo "Updating Ruby gems..."
      - cmd: PATH=/opt/homebrew/opt/ruby/bin:$PATH bundle _2.5.12_ update
        dir: packages/ruby
      - echo "Updating Python dependencies..."
      - uv run uv-bump --pyproject-toml pyproject.toml
      - uv run uv-bump --pyproject-toml packages/python/pyproject.toml
      - uv sync --all-extras --upgrade

  build:
    desc: "Build Rust core and JavaScript bindings"
    cmds:
      - task: rust:build
      - task: js:build

  test:
    desc: "Run test suites for all languages"
    cmds:
      - task: rust:test
      - task: python:test
      - task: ruby:test
      - task: js:test

  lint:
    desc: "Run linters across the repo"
    cmds:
      - task: rust:lint
      - task: python:lint
      - task: ruby:lint
      - task: typescript:lint

  fmt:
    desc: "Format code for all languages"
    cmds:
      - task: rust:fmt
      - task: python:format
      - task: ruby:format
      - task: typescript:format

  bench:
    desc: "Run benchmark suites (Rust + Python)"
    cmds:
      - task: rust:bench
      - task: python:bench

  # Aliases (backward compatibility with legacy task names) -------------------
  test:rust:
    desc: "Alias for rust:test"
    cmds:
      - task: rust:test

  test:python:
    desc: "Alias for python:test"
    cmds:
      - task: python:test

  test:ruby:
    desc: "Alias for ruby:test"
    cmds:
      - task: ruby:test

  test:node:
    desc: "Alias for node:test"
    cmds:
      - task: node:test

  test:wasm:
    desc: "Alias for wasm:test"
    cmds:
      - task: wasm:test

  test:ts:
    desc: "Alias for typescript:test"
    cmds:
      - task: typescript:test

  test:js:
    desc: "Alias for js:test"
    cmds:
      - task: js:test

  build:cli:
    desc: "Build the html-to-markdown CLI binary"
    cmds:
      - RB_SYS_RUBY=/opt/homebrew/opt/ruby/bin/ruby RUBY=/opt/homebrew/opt/ruby/bin/ruby cargo build --release --package html-to-markdown-cli

  build:node:
    desc: "Alias for node:build"
    cmds:
      - task: node:build

  build:wasm:
    desc: "Alias for wasm:build"
    cmds:
      - task: wasm:build

  build:ts:
    desc: "Alias for typescript:build"
    cmds:
      - task: typescript:build

  build:js:
    desc: "Alias for js:build"
    cmds:
      - task: js:build

  build:demo:
    desc: "Build the GitHub Pages demo"
    cmds:
      - ./scripts/build-demo.sh

  serve:demo:
    desc: "Serve the GitHub Pages demo locally"
    dir: docs
    cmds:
      - python3 -m http.server 8000

  build:wheel-prep:
    desc: "Alias for python:wheel:prep"
    cmds:
      - task: python:wheel:prep

  cov:rust:
    desc: "Alias for rust:coverage"
    cmds:
      - task: rust:coverage

  cov:python:
    desc: "Alias for python:coverage"
    cmds:
      - task: python:coverage

  cov:all:
    desc: "Generate Rust + Python coverage reports"
    cmds:
      - task: cov:rust
      - task: cov:python

  bench:rust:
    desc: "Alias for rust:bench"
    cmds:
      - task: rust:bench

  bench:python:
    desc: "Alias for python:bench"
    cmds:
      - task: python:bench

  bench:all:
    desc: "Alias for bench"
    cmds:
      - task: bench

  clean:
    desc: "Remove build artifacts across languages"
    cmds:
      - task: rust:clean
      - task: python:clean
      - task: ruby:clean
      - task: js:clean

  pre-commit:install:
    desc: "Install prek hooks (pre-commit + commit-msg)"
    cmds:
      - prek install
      - prek install --hook-type commit-msg

  pre-commit:run:
    desc: "Run all pre-commit hooks"
    cmds:
      - prek run --all-files

  # Rust tasks ----------------------------------------------------------------
  rust:build:
    desc: "Build all Rust crates"
    cmds:
      - RB_SYS_RUBY=/opt/homebrew/opt/ruby/bin/ruby RUBY=/opt/homebrew/opt/ruby/bin/ruby cargo build --workspace --exclude html-to-markdown-rb --release

  rust:test:
    desc: "Run Rust tests"
    cmds:
      - RB_SYS_RUBY=/opt/homebrew/opt/ruby/bin/ruby RUBY=/opt/homebrew/opt/ruby/bin/ruby cargo test --release --no-default-features --workspace --exclude html-to-markdown-rb

  rust:lint:
    desc: "Run Rust fmt + clippy"
    cmds:
      - cargo fmt --all
      - RB_SYS_RUBY=/opt/homebrew/opt/ruby/bin/ruby RUBY=/opt/homebrew/opt/ruby/bin/ruby cargo clippy --workspace --exclude html-to-markdown-rb -- -D warnings

  rust:fmt:
    desc: "Format Rust code"
    cmds:
      - cargo fmt --all

  rust:bench:
    desc: "Run Rust benchmarks"
    cmds:
      - RB_SYS_RUBY=/opt/homebrew/opt/ruby/bin/ruby RUBY=/opt/homebrew/opt/ruby/bin/ruby cargo bench --package html-to-markdown

  rust:coverage:
    desc: "Generate Rust coverage report (requires cargo-llvm-cov)"
    cmds:
      - RB_SYS_RUBY=/opt/homebrew/opt/ruby/bin/ruby RUBY=/opt/homebrew/opt/ruby/bin/ruby cargo llvm-cov --all-features --workspace --exclude html-to-markdown-py --exclude html-to-markdown-rb --lcov --output-path rust-coverage.lcov
      - RB_SYS_RUBY=/opt/homebrew/opt/ruby/bin/ruby RUBY=/opt/homebrew/opt/ruby/bin/ruby cargo llvm-cov --all-features --summary-only

  rust:clean:
    desc: "Clean Rust artifacts"
    cmds:
      - cargo clean

  # Python tasks --------------------------------------------------------------
  python:install:
    desc: "Install Python dependencies via uv"
    dir: packages/python
    cmds:
      - uv sync --all-extras

  python:test:
    desc: "Run Python tests (build CLI first for proxy tests)"
    cmds:
      - RB_SYS_RUBY=/opt/homebrew/opt/ruby/bin/ruby RUBY=/opt/homebrew/opt/ruby/bin/ruby cargo build --release --package html-to-markdown-cli
      - cmd: uv run pytest
        dir: packages/python

  python:test:cov:
    desc: "Run Python tests with coverage"
    cmds:
      - RB_SYS_RUBY=/opt/homebrew/opt/ruby/bin/ruby RUBY=/opt/homebrew/opt/ruby/bin/ruby cargo build --release --package html-to-markdown-cli
      - cmd: uv run pytest --cov=html_to_markdown --cov-report=term-missing
        dir: packages/python

  python:bench:
    desc: "Run Python benchmark suite"
    cmds:
      - RB_SYS_RUBY=/opt/homebrew/opt/ruby/bin/ruby RUBY=/opt/homebrew/opt/ruby/bin/ruby cargo build --release --package html-to-markdown-cli
      - cmd: uv run pytest tests/benchmark_wikipedia_test.py --benchmark-only -v
        dir: packages/python

  python:lint:
    desc: "Lint Python code with ruff + mypy"
    dir: packages/python
    cmds:
      - uv run ruff check
      - uv run mypy

  python:format:
    desc: "Format Python code"
    dir: packages/python
    cmds:
      - uv run ruff check --fix
      - uv run ruff format

  python:coverage:
    desc: "Generate Python coverage lcov file"
    cmds:
      - RB_SYS_RUBY=/opt/homebrew/opt/ruby/bin/ruby RUBY=/opt/homebrew/opt/ruby/bin/ruby cargo build --release --package html-to-markdown-cli
      - cmd: uv run pytest --cov=html_to_markdown --cov-report=lcov:coverage.lcov --cov-report=term
        dir: packages/python

  python:wheel:prep:
    desc: "Prepare CLI binary for wheel packaging"
    cmds:
      - uv run scripts/prepare_wheel.py

  python:clean:
    desc: "Clean Python build artifacts"
    dir: packages/python
    cmds:
      - rm -rf build/ dist/ *.egg-info .pytest_cache .ruff_cache .mypy_cache html_to_markdown/bin

  # Ruby tasks ----------------------------------------------------------------
  ruby:install:
    desc: "Install Ruby dependencies"
    cmds:
      - cmd: cd packages/ruby && PATH=/opt/homebrew/opt/ruby/bin:$PATH bundle _2.5.12_ install

  ruby:build:
    desc: "Build Ruby native extension"
    cmds:
      - cmd: cd packages/ruby && PATH=/opt/homebrew/opt/ruby/bin:$PATH bundle _2.5.12_ exec rake compile

  ruby:test:
    desc: "Run Ruby specs"
    cmds:
      - task: ruby:build
      - cmd: cd packages/ruby && PATH=/opt/homebrew/opt/ruby/bin:$PATH bundle _2.5.12_ exec rake spec

  ruby:lint:
    desc: "Lint Ruby code"
    cmds:
      - cmd: cd packages/ruby && PATH=/opt/homebrew/opt/ruby/bin:$PATH bundle _2.5.12_ exec rubocop --config ./.rubocop.yml

  ruby:format:
    desc: "Auto-correct Ruby lint issues"
    cmds:
      - cmd: cd packages/ruby && PATH=/opt/homebrew/opt/ruby/bin:$PATH bundle _2.5.12_ exec rubocop --config ./.rubocop.yml --autocorrect

  ruby:clean:
    desc: "Clean Ruby build artifacts"
    dir: packages/ruby
    cmds:
      - rm -rf lib/*.bundle lib/*.so pkg/ tmp/

  # JavaScript / TypeScript tasks --------------------------------------------
  js:install:
    desc: "Install pnpm workspace dependencies"
    cmds:
      - pnpm install --frozen-lockfile

  js:build:
    desc: "Build Node, WASM, and TypeScript packages"
    cmds:
      - task: node:build
      - task: wasm:build
      - task: typescript:build

  js:test:
    desc: "Run Node, WASM, and TypeScript tests"
    cmds:
      - task: node:test
      - task: wasm:test
      - task: typescript:test

  js:clean:
    desc: "Clean JS/TS build artifacts"
    cmds:
      - find crates packages -type d -name "dist" -exec rm -rf {} + 2>/dev/null || true
      - find crates packages -type d -name "node_modules" -exec rm -rf {} + 2>/dev/null || true

  node:build:
    desc: "Build Node.js native bindings"
    cmds:
      - pnpm --filter html-to-markdown-node run build

  node:test:
    desc: "Run Node.js binding tests"
    cmds:
      - pnpm --filter html-to-markdown-node test

  wasm:build:
    desc: "Build WebAssembly bindings"
    cmds:
      - pnpm --filter html-to-markdown-wasm run build:all

  wasm:test:
    desc: "Run WebAssembly tests"
    cmds:
      - pnpm --filter html-to-markdown-wasm test

  typescript:build:
    desc: "Build the TypeScript distribution"
    cmds:
      - pnpm --filter html-to-markdown run build

  typescript:test:
    desc: "Test the TypeScript distribution"
    cmds:
      - pnpm --filter html-to-markdown test

  typescript:lint:
    desc: "Lint the TypeScript distribution"
    cmds:
      - pnpm --filter html-to-markdown run lint

  typescript:format:
    desc: "Format TypeScript sources"
    cmds:
      - pnpm --filter html-to-markdown run lint:fix

  # Misc tasks ----------------------------------------------------------------
  docs:build:
    desc: "Build documentation site"
    cmds:
      - task: python:install
      - uv run mkdocs build --clean --strict

  default:
    desc: "List available tasks"
    cmds:
      - task --list
