<!--
ðŸ¤– GENERATED FILE - DO NOT EDIT DIRECTLY
===========================================

This file was automatically generated by ai-rulez from ai-rulez.yaml.

âš ï¸  IMPORTANT FOR AI ASSISTANTS AND DEVELOPERS:
- DO NOT modify this file directly
- DO NOT add, remove, or change rules in this file
- Changes made here will be OVERWRITTEN on next generation

âœ… TO UPDATE RULES:
1. Edit the source configuration: ai-rulez.yaml
2. Regenerate this file: ai-rulez generate
3. The updated CLAUDE.md will be created automatically

ðŸ“ Generated: 2025-09-13 09:01:52
ðŸ“ Source: ai-rulez.yaml
ðŸŽ¯ Target: CLAUDE.md
ðŸ“Š Content: 7 rules, 3 sections

Learn more: https://github.com/Goldziher/ai-rulez
===========================================
-->

# html-to-markdown

A modern, type-safe Python library for converting HTML to Markdown with comprehensive HTML5 support, advanced table handling, and customizable conversion options. Built with BeautifulSoup4, it features streaming support, metadata extraction, custom converters, and a full CLI interface. Emphasizes strict type safety with MyPy and maintains 100% test coverage.

Version: 1.0.0

Generated on 2025-09-13 09:01:52

Total content: 7 rules, 3 sections

## Testing with Pytest and Fixtures

**Priority:** critical

Write comprehensive pytest tests using fixtures from conftest.py for common HTML structures. Maintain 100% coverage using pytest-cov with fail_under=100. Test all converter functions with edge cases including nested elements, malformed HTML, and empty inputs. Use pytest-mock for external dependencies. Test both convert_to_markdown and convert_to_markdown_stream APIs.

## Type Safety and Annotations

**Priority:** critical

Use Python 3.10+ type hints for all function signatures and class attributes. Enforce strict MyPy checking with disallow_untyped_defs=true. Use TYPE_CHECKING imports to avoid circular dependencies. Prefer concrete types over Any, and use TypeVar for generic functions. Always specify return types including Generator/Iterator types for streaming functions.

## Code Quality with Ruff

**Priority:** high

Format code with ruff using 120 character line length. Follow Google docstring convention. Ignore specific ruff rules: D100-D107 (docstrings), EM/TRY (exception handling), FBT (boolean args). Run pre-commit hooks including ruff format and ruff check. Use uv for dependency management and virtual environments.

## Converter Architecture Pattern

**Priority:** high

Implement converters as pure functions in html_to_markdown.converters following the pattern: converter_name(tag: Tag, ...) -> str. Use partial functions for configuration. Format block elements with \_format_block_element() and inline elements with \_format_inline_or_block(). Register converters in the CONVERTER_MAPPING dictionary. Support custom converters via converters parameter.

## Prerequisites

- Python 3.10+ (project uses 3.10-3.13)
- uv package manager

## Setup Development Environment

```bash
# Clone the repository
git clone https://github.com/Goldziher/html-to-markdown.git
cd html-to-markdown

# Install dependencies using uv
uv sync --all-extras --dev

# Install pre-commit hooks
uv run pre-commit install
```

## Running Tests

```bash
# Run all tests with coverage
uv run pytest --cov=html_to_markdown --cov-report=term-missing

# Run specific test files
uv run pytest tests/tables_test.py
uv run pytest tests/cli_test.py
```

## Code Quality Checks

```bash
# Run linting and formatting
uv run ruff check --fix .
uv run ruff format .

# Type checking with mypy
uv run mypy

# Run all pre-commit hooks
uv run pre-commit run --all-files
```

## Error Handling with Custom Exceptions

**Priority:** high

Raise appropriate custom exceptions from html_to_markdown.exceptions (HtmlToMarkdownError, ConflictingOptionsError, EmptyHtmlError, InvalidParserError, MissingDependencyError). Never catch generic Exception without re-raising. Use nh3 for HTML sanitization when processing untrusted input. Validate BeautifulSoup parser availability before use.

## BeautifulSoup4 Tag Processing

**Priority:** medium

Use BeautifulSoup4 Tag objects for HTML parsing. Access attributes via tag.attrs dictionary. Use tag.get_text(strip=True) for text extraction. Handle NavigableString vs Tag types explicitly. Support both lxml and html.parser backends. Process children recursively using tag.children or tag.descendants.

## Core Components

### Main Module Structure

- `html_to_markdown/converters.py` - HTML tag converter strategies
- `html_to_markdown/processing.py` - Main conversion logic
- `html_to_markdown/preprocessor.py` - HTML cleaning and preprocessing
- `html_to_markdown/whitespace.py` - Whitespace normalization modes

### Converter Pattern

Each HTML tag has a dedicated converter function in `converters.py`:

```python
def convert_h1(*, tag: Tag, text: str, **kwargs) -> str:
    """Convert h1 tags to markdown headers."""
    return f"# {text}\n\n"
```

### Custom Converters

Override any tag's conversion behavior:

```python
from html_to_markdown import convert_to_markdown

def my_link_converter(*, tag: Tag, text: str, **kwargs) -> str:
    href = tag.get("href", "")
    return f"[{text}]({href} 'Custom Link')"

markdown = convert_to_markdown(html, custom_converters={"a": my_link_converter})
```

### Preprocessing Presets

- `minimal` - Basic cleanup only
- `standard` - Balanced cleaning (default)
- `aggressive` - Heavy cleaning for web scraping

## Performance and Memory Optimization

**Priority:** medium

Implement streaming conversion for large documents via convert_to_markdown_stream with progress callbacks. Use generators for memory-efficient processing. Cache compiled regex patterns in constants.py. Avoid repeated string concatenation in loops. Process tables with rowspan/colspan efficiently using cell tracking. Benchmark performance with tests/performance_test.py.

## Test Organization

Tests are organized by feature in `tests/`:

- `tests/tables_test.py` - Table conversion tests
- `tests/lists_test.py` - List handling tests
- `tests/cli_test.py` - CLI functionality tests
- `tests/custom_converters_test.py` - Custom converter tests

## Writing Tests

```python
# Use pytest fixtures from conftest.py
def test_table_with_rowspan(convert):
    html = '<table><tr><td rowspan="2">A</td><td>B</td></tr></table>'
    result = convert(html)
    assert "| A | B |" in result
```

## Coverage Requirements

- Project maintains 100% test coverage
- Coverage report fails under 100%
- Run `uv run pytest --cov` to check coverage

## Performance Testing

See `tests/performance_test.py` for benchmarking:

```bash
# Run performance benchmarks
uv run pytest tests/performance_test.py -v
```
